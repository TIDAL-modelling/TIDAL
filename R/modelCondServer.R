#' split model by variable
#'
#' @import broom.mixed
#' @import lme4
#' @import dplyr
#' @import ggplot2
#' @import tidyr
#' @import multcomp
#' @import tibble
#' @import tinytex
#' @import rmarkdown
#' @importFrom stats IQR confint deviance fitted median pnorm qnorm sd
#' @import utils
#' @importFrom kableExtra kbl kable_styling landscape
#' @importFrom car deltaMethod
#' @importFrom rlang :=
#'
#' @keywords internal
#' @name modelCondServer
utils::globalVariables(c(".", "statistic", "p.z", "pred", "condition", "Age", "Phenotype", "lower", "upper"))
modelCondServer <- function(id,
                            modelData,
                            formCodeCovars,
                            dfPlot,
                            traj,
                            age,
                            covars,
                            timePoint,
                            modelType,
                            REML_choice,
                            randomFX) {

  moduleServer(
    id,
    function(input, output, session) {

      ns <- NS(id)

      # ---------------------------------------
      # Allow the user to select a variable from the column names of the dataset
      # Note if the user selects categorical then only columns with less than 40 unique values are shown (as more than this is messy and likely not to be a categorical variable as it's unusual to have that many categories)
      # If the user selects continuous then only columns with more than 2 unique values are shown, ie. this removes things like males/females and other binary categorical variables.
      vars <- reactive({
        req(modelData())
        if(input$varType == "cat"){
          str_subset(colnames(modelData())[apply(modelData(), 2, function(x) length(unique(x))) < 40], "COPY_OF_WEIGHT_COLUMN_USED_IN_LMER", negate = TRUE)
        }else if(input$varType == "cont"){
          str_subset(colnames(modelData())[!apply(modelData(), 2, function(x) length(unique(x))) <= 2], "COPY_OF_WEIGHT_COLUMN_USED_IN_LMER", negate = TRUE)
        }else{
          colnames(modelData())
        }
      })

      observeEvent(vars(),{
        req(modelData())

        updateSelectInput(
          session,
          "condition",
          choices = vars()
        )
      })

      # ---------------------------------------
      # If the user has selected a variable that is already a covariate print a warning message
      # and don't run anything further
      output$warningCov <- renderText({
        if(str_detect(formCodeCovars(), input$condition)){
          paste0("Error: You have chosen to condition on a variable that was chosen as a covariate on the previous page.\n
                 Please go back and remove it as a covariate or choose another variable.")
        }
      })


      # ---------------------------------------
      # z-scale continuous variable
      # either factorise or make numeric the input$condition depending on the input$varType option
      modelDataScaled <- eventReactive(input$button,{
        colSplit <- which(colnames(modelData()) %in% input$condition)

        if(input$varType == "cat"){
          modelData() %>%
            filter(!is.na(!!sym(input$condition))) %>%
            mutate(!!input$condition := factor( str_replace_all(.[[colSplit]], " |-|/", "_") ) )

        }else if(input$varType == "cont"){
          modelData() %>%
            mutate(!!input$condition := scale(.[[colSplit]]) )
        }
      })

      output$zScore <- renderText({
        if(input$varType == "cat"){
          paste0("")
        }else if(input$varType == "cont"){
          paste0('Variable: "', input$condition, '" has been z-score standardised.')
        }
      })

      # ---------------------------------------
      # Run lme4
      fit <- eventReactive(input$button,{

        if(modelType() == "Linear"){
          fit <- lmer(formula = paste0(formCodeCovars(),
                                       "+ ", input$condition,
                                       " + ", age(), "*", input$condition
          ),
          REML=REML_choice() , data = modelDataScaled(),
          control=lmerControl(optimizer="bobyqa",
                              optCtrl=list(maxfun=2e5)))
        } else if(modelType() == "Quadratic"){
          fit <- lmer(formula = paste0(formCodeCovars(),
                                       "+ ", input$condition,
                                       " + ", age(), "*", input$condition,
                                       " + I(", age(), "^2)*", input$condition
          ),
          REML=REML_choice() , data = modelDataScaled(),
          control=lmerControl(optimizer="bobyqa",
                              optCtrl=list(maxfun=2e5)))
        } else if(modelType() == "Cubic"){
          fit <- lmer(formula = paste0(formCodeCovars(),
                                       "+ ", input$condition,
                                       " + ", age(), "*", input$condition,
                                       " + I(", age(), "^2)*", input$condition,
                                       " + I(", age(), "^3)*", input$condition
          ),
          REML=REML_choice() , data = modelDataScaled(),
          control=lmerControl(optimizer="bobyqa",
                              optCtrl=list(maxfun=2e5)))
        } else if(modelType() == "Quartic"){
          fit <- lmer(formula = paste0(formCodeCovars(),
                                       "+ ", input$condition,
                                       " + ", age(), "*", input$condition,
                                       " + I(", age(), "^2)*", input$condition,
                                       " + I(", age(), "^3)*", input$condition,
                                       " + I(", age(), "^4)*", input$condition
          ),
          REML=REML_choice() , data = modelDataScaled(),
          control=lmerControl(optimizer="bobyqa",
                              optCtrl=list(maxfun=2e5)))
        }
        return(fit)
      })

      # ---------------------------------------
      # add code chunk for formula
      warningMsg <- eventReactive(input$button, {
        if(class(fit()) != "try-error"){

          if(modelType() == "Linear"){
            formula = paste0(formCodeCovars(),
                                         "+ ", input$condition,
                                         " + ", age(), "*", input$condition
            )
          } else if(modelType() == "Quadratic"){
            formula = paste0(formCodeCovars(),
                                         "+ ", input$condition,
                                         " + ", age(), "*", input$condition,
                                         " + I(", age(), "^2)*", input$condition
            )
          } else if(modelType() == "Cubic"){
            formula = paste0(formCodeCovars(),
                                         "+ ", input$condition,
                                         " + ", age(), "*", input$condition,
                                         " + I(", age(), "^2)*", input$condition,
                                         " + I(", age(), "^3)*", input$condition
            )
          } else if(modelType() == "Quartic"){
            formula = paste0(formCodeCovars(),
                                         "+ ", input$condition,
                                         " + ", age(), "*", input$condition,
                                         " + I(", age(), "^2)*", input$condition,
                                         " + I(", age(), "^3)*", input$condition,
                                         " + I(", age(), "^4)*", input$condition
            )
          }

          paste0('
            The following <a href="https://cran.r-project.org/web/packages/lme4/lme4.pdf" style="color:blue" target="_blank">lme4</a> function is used to run the model:
            </br>
            <pre>
            <code>',
                   paste0('lmer(formula = ',formula,',
                 REML = ',REML_choice(),' ,
                 data = newModelData,
                 control = lmerControl(optimizer="bobyqa",
                                      optCtrl=list(maxfun=2e5)))'),
                 '</code>
            </pre>
            Please see more infomation about the &quot;bobyqa&quot; optimiser <a href="https://cran.r-project.org/web/packages/lme4/vignettes/lmerperf.html" style="color:blue" target="_blank"> here</a>. The use of alternative optimisers is not currently supported.
            </br>
            The argument <code>REML</code> is either: <code>FALSE</code>, indicating the model was fitted by maximum likelihood, or <code>TRUE</code> indicating the model was fitted using restricted maximum likelihood.
            Please note the lme4 weights argument is not yet an option on this page.')
        }else{
          "The model doesn't run. This could be because there is too much missing data or too few time points."
        }
      })

      # Warning text
      output$warning <- renderText({
        warningMsg()
      })


      # ---------------------------------------
      # Add columns to the data frame

      modelDataEdit <- eventReactive(input$button,{

        # select the index for the column that the user wants to split the analysis on
        colSplit <- which(colnames(modelDataScaled()) %in% input$condition)

        # add the "predicted" column to this dataset (it's not really a prediction because its the same dataset, it just shows the model)

        ageVec <- modelDataScaled() %>% pull(!!age())

        coef <- summary(fit())$coefficients

        if(modelType() == "Linear"){
          zero <- ageVec * coef[2,1] + coef[1,1]

        } else if(modelType() == "Quadratic"){
          zero  <- ageVec * coef[2,1] + coef[1,1] +
            ageVec^2 * coef[3,1]

        } else if(modelType() == "Cubic"){
          zero  <- ageVec * coef[2,1] + coef[1,1]  +
            ageVec^2 * coef[3,1] +
            ageVec^3 * coef[4,1]

        } else if(modelType() == "Quartic"){
          zero  <- ageVec * coef[2,1] + coef[1,1]  +
            ageVec^2 * coef[3,1] +
            ageVec^3 * coef[4,1] +
            ageVec^4 * coef[5,1]

        }

        rowIndex <- which(str_detect(string = row.names(coef),
                                     pattern = input$condition) &
                            str_detect(string = row.names(coef),
                                       pattern = ":", negate = T))

        rowIndexInteract1 <- which(str_detect(string = row.names(coef),
                                              pattern = input$condition) &
                                     str_detect(string = row.names(coef),
                                                pattern = ":") &
                                     str_detect(string = row.names(coef),
                                                pattern = "\\^", negate = T))

        rowIndexInteract2 <- which(str_detect(string = row.names(coef),
                                              pattern = input$condition) &
                                     str_detect(string = row.names(coef),
                                                pattern = ":") &
                                     str_detect(string = row.names(coef),
                                                pattern = "\\^2"))

        rowIndexInteract3 <- which(str_detect(string = row.names(coef),
                                              pattern = input$condition) &
                                     str_detect(string = row.names(coef),
                                                pattern = ":") &
                                     str_detect(string = row.names(coef),
                                                pattern = "\\^3"))

        rowIndexInteract4 <- which(str_detect(string = row.names(coef),
                                              pattern = input$condition) &
                                     str_detect(string = row.names(coef),
                                                pattern = ":") &
                                     str_detect(string = row.names(coef),
                                                pattern = "\\^4"))

        if(input$varType == "cat"){
          n <- length(unique(pull(modelDataScaled(), !!sym(input$condition))))

          predCovs <- lapply(1:(n-1), function(i){
            if(modelType() == "Linear"){
              coef[1,1] +
              (ageVec * coef[2,1]) +
              coef[rowIndex[i],1] +
              (ageVec * coef[rowIndexInteract1[i],1])
            } else if(modelType() == "Quadratic"){
              coef[1,1] +
              ageVec * coef[2,1] +
              coef[rowIndex[i],1] +
              ageVec^2 * coef[3,1] +
              (ageVec * coef[rowIndexInteract1[i],1]) +
              (ageVec^2 * coef[(rowIndexInteract2)[i],1])
            } else if(modelType() == "Cubic"){
              coef[1,1] +
              ageVec * coef[2,1] +
              coef[rowIndex[i],1] +
              ageVec^2 * coef[3,1] +
              ageVec^3 * coef[4,1] +
              (ageVec * coef[rowIndexInteract1[i],1]) +
              (ageVec^2 * coef[(rowIndexInteract2)[i],1]) +
              (ageVec^3 * coef[(rowIndexInteract3)[i],1])
            } else if(modelType() == "Quartic"){
              coef[1,1] +
              ageVec * coef[2,1] +
                coef[rowIndex[i],1]  +
                ageVec^2 * coef[3,1] +
                ageVec^3 * coef[4,1] +
                ageVec^4 * coef[5,1] +
                (ageVec * coef[rowIndexInteract1[i],1]) +
                (ageVec^2 * coef[(rowIndexInteract2)[i],1]) +
                (ageVec^3 * coef[(rowIndexInteract3)[i],1]) +
                (ageVec^4 * coef[(rowIndexInteract4)[i],1])
            }
          })

          num <- str_subset(row.names(coef), input$condition) %>%
            sub(paste0(".*", input$condition), "", .) %>%
            unique()

          names(predCovs) <- paste0(input$condition, "_", num)

          modelDataEdit <- cbind(modelDataScaled(), do.call(cbind, predCovs)) %>%
            mutate(zero = zero) %>%
            mutate(!!input$condition := as.factor(.[[colSplit]]) ) %>%
            mutate(pred =  eval(parse(text =
                                        paste0(paste0("ifelse(", input$condition, " == '", num, "', ", input$condition, "_",num,",", collapse = " "), "zero",
                                               paste0(rep(")", length(num)), collapse = ""), collapse = "")
            )))

        }else if(input$varType == "cont"){
        # Get the ±1 SD for this predict/population average line
          if(modelType() == "Linear"){
            plus <- ageVec * coef[2,1] +
              coef[1,1] +
              coef[rowIndex,1]  +
              (ageVec * coef[rowIndexInteract1,1])

            minus <- ageVec * coef[2,1] +
              coef[1,1] -
              coef[rowIndex,1] -
              (ageVec * coef[rowIndexInteract1,1])

          } else if(modelType() == "Quadratic"){
            plus  <- ageVec * coef[2,1] +
              coef[1,1] +
              ageVec^2 * coef[3,1] +
              coef[rowIndex,1] +
              (ageVec * coef[rowIndexInteract1,1]) +
              (ageVec^2 * coef[(rowIndexInteract2),1])

            minus <- ageVec * coef[2,1] +
              coef[1,1] +
              ageVec^2 * coef[3,1] -
              coef[rowIndex,1] -
              (ageVec * coef[rowIndexInteract1,1]) -
              (ageVec^2 * coef[(rowIndexInteract2),1])

          } else if(modelType() == "Cubic"){
            plus  <- ageVec * coef[2,1] +
              coef[1,1]  +
              ageVec^2 * coef[3,1] +
              ageVec^3 * coef[4,1] +
              coef[rowIndex,1] +
              (ageVec * coef[rowIndexInteract1,1]) +
              (ageVec^2 * coef[(rowIndexInteract2),1]) +
              (ageVec^3 * coef[(rowIndexInteract3),1])

            minus <-  ageVec * coef[2,1] +
              coef[1,1]  +
              ageVec^2 * coef[3,1] +
              ageVec^3 * coef[4,1] -
              coef[rowIndex,1] -
              (ageVec * coef[rowIndexInteract1,1]) -
              (ageVec^2 * coef[(rowIndexInteract2),1]) -
              (ageVec^3 * coef[(rowIndexInteract3),1])

          } else if(modelType() == "Quartic"){
            plus  <- ageVec * coef[2,1] +
              coef[1,1]  +
              ageVec^2 * coef[3,1] +
              ageVec^3 * coef[4,1] +
              ageVec^4 * coef[5,1] +
              coef[rowIndex,1] +
              (ageVec * coef[rowIndexInteract1,1]) +
              (ageVec^2 * coef[(rowIndexInteract2),1]) +
              (ageVec^3 * coef[(rowIndexInteract3),1]) +
              (ageVec^4 * coef[(rowIndexInteract4),1])

            minus <-  ageVec * coef[2,1] +
              coef[1,1]  +
              ageVec^2 * coef[3,1] +
              ageVec^3 * coef[4,1] +
              ageVec^4 * coef[5,1] -
              coef[rowIndex,1] -
              (ageVec * coef[rowIndexInteract1,1]) -
              (ageVec^2 * coef[(rowIndexInteract2),1]) -
              (ageVec^3 * coef[(rowIndexInteract3),1]) -
              (ageVec^4 * coef[(rowIndexInteract4),1])
          }

          modelDataEdit <- modelDataScaled() %>%
            mutate(pred = zero) %>%
            mutate(plus = plus) %>%
            mutate(minus = minus)
        }
        return(modelDataEdit)
      })
      # ---------------
      # model results
      modelStatsFixed <- reactive({
        if(str_detect(formCodeCovars(), input$condition)){
          data.frame(NULL)
        }else{
          cbind(
            tidy(fit(), "fixed"),
            confint(fit(), "beta_", method = "Wald")) %>%
            mutate(p.z = 2 * (1 - pnorm(abs(statistic)))) %>%
            mutate(p.z = ifelse(p.z < 0.001, "p < 0.001", round(p.z, 3) ))
        }
      })

      output$modelStatsFixed <- renderTable({
        modelStatsFixed()
        }, digits = 3)

      # -------------------------------
      # Interpretation of fixed effects
      interpretation <- eventReactive(fit(), {
        req(modelDataEdit())

        # Intercept:
        intercept <- round(modelStatsFixed()$estimate[1], 3)

        # Age variable name:
        ageVar <- age()

        # # y-axis name:
        trajVar <- traj()

        # Mean age:
        ageMeanVal <- modelDataEdit() %>%
          pull(age_original) %>%
          mean(na.rm = T) %>%
          round(2)

        # Slope:
        slope <- round(modelStatsFixed()$estimate[2], 3)

        if(modelType() %in% c("Quadratic", "Cubic", "Quartic") ){
          slope2 <- round(modelStatsFixed()$estimate[3], 3)
          direction2 <- ifelse(slope2 >= 0 , "an increase", "a decrease")
        }
        if(modelType() %in% c("Cubic", "Quartic")){
          slope3 <- round(modelStatsFixed()$estimate[4], 3)
          direction3 <- ifelse(slope3 >= 0 , "an increase", "a decrease")
        }
        if(modelType() == "Quartic"){
          slope4 <- round(modelStatsFixed()$estimate[5], 3)
          direction4 <- ifelse(slope4 >= 0 , "an increase", "a decrease")
        }


        # Direction
        direction <- ifelse(slope >= 0 , "an increase", "a decrease")

        # Confounders:
        confounders <- paste0(covars(), collapse = ", ")

        # Confounder level names and estimates
        if(length(covars()) > 0){
          i <- which(str_detect(modelStatsFixed()$term, paste0(covars(), collapse = "|")))
          confounderLevels <- paste0(modelStatsFixed()$term[i] , collapse = ", ")
          confounderEst <- paste0(round(modelStatsFixed()$estimate[i],2) , collapse = ", ")
        }

        if (input$varType == "cat") {
          lowestLevel <- paste0(input$condition, as.character(levels(pull(modelDataEdit(), !!sym(input$condition))))[1])

          # Common message
          commonMessage <- paste0(
            'The interaction variable you have chosen has been factorised with the lowest level "', lowestLevel, '" being the reference or baseline category. ',
            'For the level "', lowestLevel, '", the score at the intercept is ', intercept, '. The intercept here has been shifted to the mean age of all the assessments which is ', ageMeanVal, '. ',
            'You could interpret this as the score at the intercept for "', lowestLevel, '" at ', ageMeanVal, ' is ', intercept, '.', ifelse(length(covars()) > 0, paste0(' Because you have adjusted for the following confounders/covariates: ', confounders, ',  this score reflects individuals with the lowest categorical covariate and/or the mean of continuous covariates.'),'' ), '<br/><br/> ',
            '',
            'For the level "', lowestLevel, '", every unit increase in ', ageVar, ' is associated with ', direction, ' of "', trajVar, '" by ', abs(slope), '. <br/><br/> '
          )

        } else if (input$varType == "cont") {
          commonMessage <- paste0(
            'The interaction variable you have chosen has been standardised to have a mean of 0 and a standard deviation of 1. ',
            'The intercept and ', ageVar, ' estimates are when the interaction has been set to 0. ',
            'You could interpret this as the score at the intercept is ', intercept, '. ',
            'The intercept here has been shifted to the mean age of all the assessments, which is ', ageMeanVal, '. ',
            'You could interpret this as the score at the intercept (when your interaction is set to 0) at ', ageMeanVal, ' is ', intercept, '.', ifelse(length(covars()) > 0, paste0(' Because you have adjusted for the following confounders/covariates: ', confounders, ',  this score reflects individuals with the lowest categorical covariate and/or the mean of continuous covariates.'), ''), '<br/><br/> ',
            'Every unit increase in ', ageVar, ' is associated with ', direction, ' of "', trajVar, '" by ', abs(slope), '.<br/><br/> '
          )

        }

        covarsMessage <- paste0(ifelse(length(covars()) > 0, paste0('In addition, the following confounders/covariates: ', confounderLevels, ' are associated with an increase or decrease of ', trajVar, ' by ', confounderEst, ' respectively.<br/><br/>'), ''), '')

        # Determine the model-specific message
        if (input$varType == "cat") {
          if(modelType() ==  "Linear")
            modelSpecificMessage <-  paste0('It is possible to estimate different trajectory groups by adding the intercept and ', ageVar, ' estimates to the corresponding group effect estimate and ', ageVar, ':group-interaction estimates to get group specific trajectories. If you are interested in the effect of the interaction only, then you can ignore the intercept and ', ageVar, ' estimates and focus solely on the corresponding interactions and ', ageVar, ':group-interactions estimates.')

          else if(modelType() ==  "Quadratic"){
            modelSpecificMessage <- paste0('As you have specified a quadratic model, every unit increase in ', ageVar ,'^2 is also associated with ', direction2 ,' of ', trajVar,' by ',abs(slope2),'. It is possible to estimate different trajectory groups by adding the intercept, ', ageVar, ' and ', ageVar ,'^2 estimates to the corresponding group effect estimate, ', ageVar, ':group-interactions and ',ageVar, '^2:group-interactions estimates to get group specific trajectories. If you are interested in the effect of the interaction only, then you can ignore the intercept, ', ageVar, ' and ', ageVar ,'^2 estimates and focus solely on the corresponding interactions, ', ageVar, ':group-interactions and ',ageVar, '^2:group-interactions estimates.<br/> However, it can be difficult to interpret these estimates in isolation, so we would recommend exploring your trajectories with the "Plot" and "Scores At Ages" tabs for more information.')
          }else if(modelType() ==  "Cubic"){
            modelSpecificMessage <- paste0('As you have specified a cubic model, every unit increase in ',ageVar,'^2 is also associated with ', direction2 ,' of ', trajVar ,' by ', abs(slope2) ,'. Furthermore, every unit increase in ',ageVar,'^3 is also associated with ', direction3 ,' of ', trajVar,' by ',abs(slope3),'. It is possible to estimate different trajectory groups by adding the intercept, ', ageVar, ', ', ageVar ,'^2 and ', ageVar ,'^3 estimates to the corresponding group effect estimate, ', ageVar, ':group-interactions, ',ageVar, '^2:group-interactions and ',ageVar, '^3:group-interaction  estimates  to get group specific trajectories. If you are interested in the effect of the interaction only, then you can ignore the intercept, ', ageVar, ', ', ageVar ,'^2 and ', ageVar ,'^3 estimates and focus solely on the corresponding interactions, ', ageVar, ':group-interactions, ',ageVar, '^2:group-interactions and ',ageVar, '^3:group-interactions estimates.<br/>However, it can be difficult to interpret these estimates in isolation, so we would recommend exploring your trajectories with the "Plot" and "Scores At Ages" tabs for more information.')
          }else if (modelType() ==  "Quartic"){
            modelSpecificMessage <-  paste0('As you have specified a quartic model, every unit increase in ',ageVar,'^2 is also associated with ', direction2 ,' of ', trajVar ,' by ', abs(slope2) ,'. Furthermore, every unit increase in ',ageVar,'^3 is also associated with ', direction3 ,' of ', trajVar,' by ',abs(slope3),' and every unit increase in ',ageVar,'^4 is associated with ', direction4 ,' in ',trajVar,' by ',abs(slope4), '. It is possible to estimate different trajectory groups by adding the intercept, ', ageVar, ', ', ageVar ,'^2, ', ageVar ,'^3 and ', ageVar ,'^4 estimates to the corresponding group effect estimate, ', ageVar, ':group-interactions, ',ageVar, '^2:group-interactions, ',ageVar, '^3:group-interactions and ',ageVar, '^4:group-interactions  estimates to get group specific trajectories. If you are interested in the effect of the interaction only, then you can ignore the intercept, ', ageVar, ', ', ageVar ,'^2, ', ageVar ,'^3 and ', ageVar ,'^4 estimates and focus solely on the corresponding interactions, ', ageVar, ':group-interactions, ',ageVar, '^2:group-interactions, ',ageVar, '^3:group-interactions and ',ageVar, '^4:group-interactions estimates.<br/> However, it can be difficult to interpret these estimates in isolation, so we would recommend exploring your trajectories with the "Plot" and "Scores At Ages" tabs for more information.')
          }
        } else if (input$varType == "cont") {

          if(modelType() ==  "Linear")
            modelSpecificMessage <-  paste0('It is possible to estimate the effect of different trajectory groups by adding the intercept and ', ageVar, ' estimates to the corresponding interactions and ', ageVar, ':interactions to get group specific trajectories. If you are interested in the effect of the interaction only, then you can ignore the intercept and ', ageVar, ' estimates and focus solely on the corresponding interactions and ', ageVar, ':interactions estimates.')

          else if(modelType() ==  "Quadratic"){
            modelSpecificMessage <- paste0('As you have specified a quadratic model, every unit increase in ', ageVar ,'^2 is also associated with ', direction2 ,' of ', trajVar,' by ',abs(slope2),'. It is possible to estimate the effect of different trajectory groups by adding the intercept, ', ageVar, ' and ', ageVar ,'^2 estimates to the corresponding interactions, ', ageVar, ':interactions and ',ageVar, '^2:interactions to get group specific trajectories. If you are interested in the effect of the interaction only, then you can ignore the intercept, ', ageVar, ' and ', ageVar ,'^2 estimates and focus solely on the corresponding interactions, ', ageVar, ':interactions and ',ageVar, '^2:interactions estimates.<br/> However, it can be difficult to interpret these estimates in isolation, so we would recommend exploring your trajectories with the "Plot" and "Scores At Ages" tabs for more information.')
          }else if(modelType() ==  "Cubic"){
            modelSpecificMessage <- paste0('As you have specified a cubic model, every unit increase in ',ageVar,'^2 is also associated with ', direction2 ,' of ', trajVar ,' by ', abs(slope2) ,'. Furthermore, every unit increase in ',ageVar,'^3 is also associated with ', direction3 ,' of ', trajVar,' by ',abs(slope3),'. It is possible to estimate the effect of different trajectory groups by adding the intercept, ', ageVar, ', ', ageVar ,'^2 and ', ageVar ,'^3 estimates to the corresponding interactions, ', ageVar, ':interactions, ',ageVar, '^2:interactions and ',ageVar, '^3:interactions to get group specific trajectories. If you are interested in the effect of the interaction only, then you can ignore the intercept, ', ageVar, ', ', ageVar ,'^2 and ', ageVar ,'^3 estimates and focus solely on the corresponding interactions, ', ageVar, ':interactions, ',ageVar, '^2:interactions and ',ageVar, '^3:interactions estimates.<br/>However, it can be difficult to interpret these estimates in isolation, so we would recommend exploring your trajectories with the "Plot" and "Scores At Ages" tabs for more information.')
          }else if (modelType() ==  "Quartic"){
            modelSpecificMessage <-  paste0('As you have specified a quartic model, every unit increase in ',ageVar,'^2 is also associated with ', direction2 ,' of ', trajVar ,' by ', abs(slope2) ,'. Furthermore, every unit increase in ',ageVar,'^3 is also associated with ', direction3 ,' of ', trajVar,' by ',abs(slope3),' and every unit increase in ',ageVar,'^4 is associated with ', direction4 ,' in ',trajVar,' by ',abs(slope4), '. It is possible to estimate the effect of different trajectory groups by adding the intercept, ', ageVar, ', ', ageVar ,'^2, ', ageVar ,'^3 and ', ageVar ,'^4 estimates to the corresponding interactions, ', ageVar, ':interactions, ',ageVar, '^2:interactions, ',ageVar, '^3:interactions and ',ageVar, '^4:interactions to get group specific trajectories. If you are interested in the effect of the interaction only, then you can ignore the intercept, ', ageVar, ', ', ageVar ,'^2, ', ageVar ,'^3 and ', ageVar ,'^4 estimates and focus solely on the corresponding interactions, ', ageVar, ':interactions, ',ageVar, '^2:interactions, ',ageVar, '^3:interactions and ',ageVar, '^4:interactions estimates.<br/> However, it can be difficult to interpret these estimates in isolation, so we would recommend exploring your trajectories with the "Plot" and "Scores At Ages" tabs for more information.')
          }

        }

        finalMessage <- paste0(commonMessage,  covarsMessage , modelSpecificMessage, '<br/><br/>An example of interpreting multiple grouped trajectories is given on the TIDAL GitHub Documentation website: https://tidal-modelling.github.io/docs/example_code.html. Further information on how to interpret these results can be found on the TIDAL GitHub training videos section. Please also see the "Plot" tab for visualisation of these results. <br/><br/>' )


      })

      output$modelIntFixed <- renderText({
          interpretation()
      })

      # -------------------------------
      modelStatsRandom <- reactive({
        if(str_detect(formCodeCovars(), input$condition)){
          data.frame(NULL)
        }else{
          randomDF <- as.data.frame(VarCorr(fit()),
                        order = "lower.tri") %>%
            mutate(across(where(is.numeric), round, 3))
          colnames(randomDF) <- c("Level", "Variable1", "Variable2", "Variance/Covariance", "SD Variance/Covariance")
          randomDF
        }
      })

      output$modelStatsRandom <- renderTable({
        modelStatsRandom()
        }, digits = 3)

      # ------------------------------------------
      # Interpretation of random effects
      interpretationRand <- eventReactive(fit(), {
        req(modelData())

        # age/time
        ageName <- age()

        # Intercept variance
        intVar <- modelStatsRandom()[1,4]

        # Covariance between intercept and age/time covariance
        intAgeVar <- modelStatsRandom()[2,4]

        if(modelType() ==  "Linear"){
          # age/time variance
          ageVar <- modelStatsRandom()[3,4]

          # residual variance
          resVar <- modelStatsRandom()[nrow(modelStatsRandom()),4]

          # Text:
          if(randomFX() == "No random slope"){
            paste0(
              'The intercept variance (how much variability there is between individuals for their intercepts) for your model is ', intVar ,'.<br/><br/>The residual variance (how much variability there is within individuals) from your model is ',resVar,'.<br/><br/>')
          }else if(randomFX() == "Linear"){
            paste0(
              'The intercept variance (how much variability there is between individuals for their intercepts) for your model is ', intVar ,'. The covariance between the intercept and ', ageName ,' is ', intAgeVar ,'. The ',ageName,' variance (how much variability there is between individuals for their ',ageName,') is ',ageVar,'.<br/><br/>The residual variance (how much variability there is within individuals) from your model is ',resVar,'.<br/><br/>')
          }
        }else if (modelType() %in%  c("Quadratic", "Cubic", "Quartic")){
          # age/time variance
          intAgeVar2 <- modelStatsRandom()[3,4]

          # age/time variance
          ageVar <- modelStatsRandom()[4,4]

          # age/time covariance
          ageAge2CoVar <- modelStatsRandom()[5,4]

          # age/time ^2 variance
          age2Var <- modelStatsRandom()[6,4]

          # residual variance
          resVar <- modelStatsRandom()[nrow(modelStatsRandom()),4]

          if(randomFX() == "No random slope"){
            paste0('The intercept variance how much variability there is between individuals for their intercepts) for your model is ', intVar,'.<br/><br/>The residual variance (how much variability there is within individuals) from your model is ',resVar,'.<br/><br/>')
          }else if(randomFX() == "Linear"){
            # age/time variance
            ageVar <- modelStatsRandom()[3,4]
            paste0('The intercept variance how much variability there is between individuals for their intercepts) for your model is ', intVar,'. The covariance between the intercept and ',ageName,' is ',intAgeVar,'.<br/><br/>The ',ageName,' variance (how much variability there is between individuals for their ',ageName,') is ',ageVar,'.<br/><br/>The residual variance (how much variability there is within individuals) from your model is ',resVar,'.<br/><br/>')
          }else if(randomFX() == "Linear and Quadratic"){
            # age/time variance
            ageVar <- modelStatsRandom()[4,4]
            paste0('The intercept variance how much variability there is between individuals for their intercepts) for your model is ', intVar,'. The covariance between the intercept and ',ageName,' is ',intAgeVar,'. The covariance between the intercept and ',ageName,'^2 is ',intAgeVar2,'.<br/><br/>The ',ageName,' variance (how much variability there is between individuals for their ',ageName,') is ',ageVar,'. The covariance between ',ageName,' and ',ageName,'^2 is ',ageAge2CoVar,'. The ',ageName,'^2 variance (how much variability there is between individuals for their ',ageName,'^2) is ',age2Var,'.<br/><br/>The residual variance (how much variability there is within individuals) from your model is ',resVar,'.<br/><br/>')
          }
        }
      })

      output$interRandom  <- renderText({
        if(!inherits(fit(), "try-error")){
          interpretationRand()
        }
      })

      # ---------------------------------------
      # Paste the model formula for the user to see (don't want it to appear straight away - could improve this)
      modelform <- reactive({
        if(str_detect(formCodeCovars(), input$condition)){
          ""
        }else{
          paste0("<b>Model Formula:</b> ",  gsub(".*formula = (.+) , data =.*", "\\1", summary(fit())$call)[2])
        }
      })

      output$form<- renderText({
        modelform()
      })

      # ---------------------------------------
      # Checkbox for which 95% CIs to display (categorical only)

      observeEvent(c(input$button), {
        if(input$varType == "cat"){
          levelNames <- as.character(levels(as.factor(pull(modelDataEdit(), !!sym(input$condition)))))
          output$plotCheckboxLevelsUI <- renderUI({
          checkboxGroupInput(ns("plotCheckboxLevels"),
                             "Display 95% confidence intervals for:",
                             choices = levelNames)
          })
        }else{
          output$plotCheckboxLevelsUI <- renderUI({})
        }
      })

      # ---------------------------------------
      # use glht to calculate 95% CIs
      CI_glht <- reactive({
        ageOrig <- modelDataEdit() %>% pull(age_original)
        ageOrig <- ageOrig[!is.na(ageOrig)]
        ageCalcs <-  c(min(ageOrig), seq(round(min(ageOrig), 1), round(max(ageOrig), 1), 0.5), max(ageOrig) )

        score <- lapply(ageCalcs, function(x){

          if(input$varType == "cat"){
            n <- length(unique(pull(modelDataEdit(), !!sym(input$condition))))
          }

          rowIndex <- which(str_detect(string = row.names(summary(fit())$coefficients),
                                       pattern = input$condition) &
                              str_detect(string = row.names(summary(fit())$coefficients),
                                         pattern = ":", negate = T))

          rowNames <- rownames(summary(fit())$coefficients)

          ageInput <- round(x - mean(ageOrig), 3)
          ageInput2 <- ageInput^2
          ageInput3 <- ageInput^3
          ageInput4 <- ageInput^4
          # --------------------
          # Change for model type
          if(modelType() == "Linear"){
            if(input$varType == "cat"){
              equations <- sapply(1:(n-1), function(i){
                paste0(rowNames[1], " + \`", rowNames[2], "\`*", ageInput, " + \`", rowNames[rowIndex[i]] , "\` + \`", rowNames[2], ":", rowNames[rowIndex[i]],"\`*",ageInput)
              })
            }

            res <- lapply(c( paste0(rowNames[1], " + \`", rowNames[2], "\`*", ageInput), equations),
                          function(X) deltaMethod(fit(),  X))%>%
              do.call(rbind,.)

          }else if(modelType() == "Quadratic"){
            if(input$varType == "cat"){
              equations <- sapply(1:(n-1), function(i){
                paste0(rowNames[1], " + ",
                       rowNames[rowIndex[i]] , " + ",
                       rowNames[2], "*", ageInput, " + \`",
                       rowNames[3], "\`*", ageInput2, " + \`",
                       rowNames[2], ":", rowNames[rowIndex[i]],"\`*",ageInput , " + \`",
                       rowNames[3], ":", rowNames[rowIndex[i]],"\`*",ageInput2 )
              })

            }

            res <- lapply(c( paste0(rowNames[1], " + ",
                             rowNames[2], "*", ageInput," + \`",
                             rowNames[3], "\`*", ageInput2),
                      equations),
                      function(X) deltaMethod(fit(),  X))%>%
              do.call(rbind,.)

          } else if(modelType() == "Cubic"){
            if(input$varType == "cat"){
              equations <- sapply(1:(n-1), function(i){
                paste0(rowNames[1], " + ",
                       rowNames[rowIndex[i]] , " + ",
                       rowNames[2], "*", ageInput, " + \`",
                       rowNames[3], "\`*", ageInput2, " + \`",
                       rowNames[4], "\`*", ageInput3,  " + \`",
                       rowNames[2], ":", rowNames[rowIndex[i]],"\`*",ageInput , " + \`",
                       rowNames[3], ":", rowNames[rowIndex[i]],"\`*",ageInput2 , " + \`",
                       rowNames[4], ":", rowNames[rowIndex[i]],"\`*",ageInput3 )
              })

            }

            res <- lapply( c( paste0(rowNames[1], " + ",
                                                  rowNames[2], "*", ageInput," + \`",
                                                  rowNames[3], "\`*", ageInput2,  " + \`",
                                                  rowNames[4], "\`*", ageInput3),
                                           equations),
                           function(X) deltaMethod(fit(),  X))%>%
              do.call(rbind,.)

          } else if(modelType() == "Quartic"){
            if(input$varType == "cat"){
              equations <- sapply(1:(n-1), function(i){
                paste0(rowNames[1], " + ",
                       rowNames[rowIndex[i]] , " + ",
                       rowNames[2], "*", ageInput, " + \`",
                       rowNames[3], "\`*", ageInput2, " + \`",
                       rowNames[4], "\`*", ageInput3,  " + \`",
                       rowNames[5], "\`*", ageInput4,  " + \`",
                       rowNames[2], ":", rowNames[rowIndex[i]],"\`*",ageInput , " + \`",
                       rowNames[3], ":", rowNames[rowIndex[i]],"\`*",ageInput2 , " + \`",
                       rowNames[4], ":", rowNames[rowIndex[i]],"\`*",ageInput3 , " + \`",
                       rowNames[5], ":", rowNames[rowIndex[i]],"\`*",ageInput4 )
              })
            }

            res <- lapply(c( paste0(rowNames[1], " + ",
                                                  rowNames[2], "*", ageInput," + \`",
                                                  rowNames[3], "\`*", ageInput2,  " + \`",
                                                  rowNames[4], "\`*", ageInput3,  " + \`",
                                                  rowNames[5], "\`*", ageInput4),
                                           equations),
                          function(X) deltaMethod(fit(),  X))%>%
              do.call(rbind,.)
          }

          # --------------------
          # Tidy results dataframe and rename rows/columns
          rowname <- paste0("Score (", traj(), ")")
          res <- data.frame(estimate = res$Estimate,
                            conf.low = res$`2.5 %`,
                            conf.high = res$`97.5 %`)

          if(input$varType == "cat"){
            levelNames <- as.character(levels(as.factor(pull(modelDataEdit(), !!sym(input$condition)))))
            res <-  res %>%
              mutate(condition = levelNames)
          }
          return( res )
        })
        return(score)
      })


      # Plot the split by variable plot
      plot <- eventReactive(c(input$button, input$plotCheckbox, input$plotCheckboxLevels), {

         if(input$varType == "cat"){
        req(CI_glht())

        ageOrig <- modelDataEdit() %>% pull(age_original)
        ageOrig <- ageOrig[!is.na(ageOrig)]
        ageCalcs <-  c(min(ageOrig), seq(round(min(ageOrig), 1), round(max(ageOrig), 1), 0.5), max(ageOrig) )
        levelNames <- as.character(levels(as.factor(pull(modelDataEdit(), !!sym(input$condition)))))

        estimate <- do.call(rbind, CI_glht()) %>%
          mutate(age = rep(ageCalcs, each = length(levelNames)) )

         }

        # Checkbox = TRUE means the descriptive stats plot is displayed above too
        # ±1 SD is plotted for continuous, categorical is split by the factor levels
        if(input$plotCheckbox == TRUE){
          if(input$varType == "cat"){
            # Create a subset of the color palette based on the selected levels
            levelNames <- as.character(levels(as.factor(pull(modelDataEdit(), !!sym(input$condition)))))
            selected_colors <- getOption("ggplot2.discrete.colour")[which(levelNames %in% input$plotCheckboxLevels)]

            ggplot() +
              geom_line(data = modelDataEdit(), aes(x= age_original ,  y = pred, color = !!sym(input$condition) ) , na.rm=T) +
              geom_ribbon(data = filter(estimate, condition %in% as.character(input$plotCheckboxLevels) ) ,
                          aes(x= age , ymin = conf.low, ymax = conf.high, fill = condition), alpha = 0.2, na.rm = T, show.legend = FALSE) +
              scale_color_manual(values = getOption("ggplot2.discrete.colour")) +
              scale_fill_manual(values = selected_colors) +
              geom_point(data = dfPlot(),aes(x=Age, y=Phenotype))+
              geom_line(data = dfPlot(),aes(x=Age, y=Phenotype)) +
              geom_errorbar(data = dfPlot(), aes(x=Age, y=Phenotype, ymin = lower, ymax = upper)) +
              theme(legend.text = element_text(color = "black"))+
              ylab(paste0("Score (", traj(), ")")) +
              xlab("Age")

          }else if(input$varType == "cont"){
            ggplot(data = dfPlot(),aes(x=Age, y=Phenotype)) +
              geom_point()+
              geom_line() +
              geom_errorbar(aes(ymin = lower, ymax = upper)) +
              geom_line(data = modelDataEdit(), aes(x= age_original ,  y = pred, color = "Population Average" ) , linewidth = 1.5, na.rm=T)+
              geom_line(data = modelDataEdit(), aes(x= age_original ,  y = plus, color = "+ 1 SD" ) , na.rm=T)+
              geom_line(data = modelDataEdit(), aes(x= age_original ,  y = minus, color = "- 1 SD" ) , na.rm=T)+
              theme(legend.text = element_text(color = "black"))+
              labs(color = "") +
              scale_color_manual(
                breaks = c("+ 1 SD", "Population Average", "- 1 SD"),
                values = c("#d55e00", "black", "#0072b2")) +
              ylab(paste0("Score (", traj(), ")")) +
              xlab("Age")
          }
        }else if(input$plotCheckbox == FALSE){
          if(input$varType == "cat"){
            # Create a subset of the color palette based on the selected levels
            levelNames <- as.character(levels(as.factor(pull(modelDataEdit(), !!sym(input$condition)))))
            selected_colors <- getOption("ggplot2.discrete.colour")[which(levelNames %in% input$plotCheckboxLevels)]

            ggplot() +
              geom_line(data = modelDataEdit(), aes(x= age_original ,  y = pred, color = !!sym(input$condition) ) , na.rm=T) +
              geom_ribbon(data = filter(estimate, condition %in% as.character(input$plotCheckboxLevels) ) ,
                          aes(x= age , ymin = conf.low, ymax = conf.high, fill = condition), alpha = 0.2, na.rm = T, show.legend = FALSE) +
              scale_color_manual(values = getOption("ggplot2.discrete.colour")) +
              scale_fill_manual(values = selected_colors) +
              theme(legend.text = element_text(color = "black")) +
              ylab(paste0("Score (", traj(), ")")) +
              xlab("Age")
          }else if(input$varType == "cont"){
            ggplot() +
              geom_line(data = modelDataEdit(), aes(x= age_original ,  y = pred, color = "Population Average" ) , linewidth = 1.5, na.rm=T)+
              geom_line(data = modelDataEdit(), aes(x= age_original ,  y = plus, color = "+ 1 SD" ) , na.rm=T)+
              geom_line(data = modelDataEdit(), aes(x= age_original ,  y = minus, color = "- 1 SD" ) , na.rm=T)+
              theme(legend.text = element_text(color = "black"))+
              labs(color = "") +
              scale_color_manual(
                breaks = c("+ 1 SD", "Population Average", "- 1 SD"),
                values = c("#d55e00", "black", "#0072b2")) +
              ylab(paste0("Score (", traj(), ")")) +
              xlab("Age")
          }
        }

      })

      output$modelCondPlot <- renderPlot({
        if(str_detect(formCodeCovars(), input$condition)){

        }else{
          plot()
        }
      })

      ###############################################################
      # --- Score for a given set of ages -----
      # ------------------------------------------
      # Allow the user to select the ages they want to calculate scores for
      output$selectAgeScore <- renderUI({
        ageOrig <- modelDataEdit() %>%
          pull(age_original)
        ageOrig <- ageOrig[!is.na(ageOrig)]

        checkboxGroupInput(ns("ageInputScore"),
                           "What ages do you want to calculate scores for?",
                           seq(ceiling(min(ageOrig, na.rm =T)),floor(max(ageOrig, na.rm =T))),
                           inline = TRUE)
      })


      # ------------------------------------------
      # use glht to calculate scores at ages
      score_glht <- reactive({
        ageOrig <- modelDataEdit() %>% pull(age_original)
        ageOrig <- ageOrig[!is.na(ageOrig)]

        score <- lapply(as.numeric(input$ageInputScore), function(x){

          if(input$varType == "cat"){
          n <- length(unique(pull(modelDataEdit(), !!sym(input$condition))))
          }

          rowIndex <- which(str_detect(string = row.names(summary(fit())$coefficients),
                                       pattern = input$condition) &
                              str_detect(string = row.names(summary(fit())$coefficients),
                                         pattern = ":", negate = T))

          rowNames <- rownames(summary(fit())$coefficients)

          ageInput <- round(x - mean(ageOrig), 3)
          ageInput2 <- ageInput^2
          ageInput3 <- ageInput^3
          ageInput4 <- ageInput^4
          # --------------------
          # Change for model type
          if(modelType() == "Linear"){
            if(input$varType == "cat"){
              equations <- sapply(1:(n-1), function(i){
                paste0(rowNames[1], " + \`", rowNames[2], "\`*", ageInput, " + \`", rowNames[rowIndex[i]] , "\` + \`", rowNames[2], ":", rowNames[rowIndex[i]],"\`*",ageInput)
              })
            }else if(input$varType == "cont"){
              equations <- c(paste0(rowNames[1], " + \`", rowNames[2], "\`*", ageInput, " + \`", rowNames[rowIndex] , "\` + \`", rowNames[2], ":", rowNames[rowIndex],"\`*",ageInput ) ,
                             paste0(rowNames[1], " + \`", rowNames[2], "\`*", ageInput, " - \`", rowNames[rowIndex] , "\` - \`", rowNames[2], ":", rowNames[rowIndex],"\`*",ageInput ) )
            }

            res <- lapply(c( paste0(rowNames[1], " + \`", rowNames[2], "\`*", ageInput), equations),
                          function(X) deltaMethod(fit(),  X))%>%
              do.call(rbind,.)

          }else if(modelType() == "Quadratic"){
            if(input$varType == "cat"){
            equations <- sapply(1:(n-1), function(i){
              paste0(rowNames[1], " + ",
                     rowNames[rowIndex[i]] , " + \`",
                     rowNames[2], "\`*", ageInput, " + \`",
                     rowNames[3], "\`*", ageInput2, " + \`",
                     rowNames[2], ":", rowNames[rowIndex[i]],"\`*",ageInput , " + \`",
                     rowNames[3], ":", rowNames[rowIndex[i]],"\`*",ageInput2 )
            })

            }else if(input$varType == "cont"){
              equations <- c(paste0(rowNames[1], " + ",
                       rowNames[rowIndex] , " + \`",
                       rowNames[2], "\`*", ageInput, " + \`",
                       rowNames[3], "\`*", ageInput2, " + \`",
                       rowNames[2], ":", rowNames[rowIndex],"\`*",ageInput , " + \`",
                       rowNames[3], ":", rowNames[rowIndex],"\`*",ageInput2 ),
                paste0(rowNames[1], " - ",
                       rowNames[rowIndex] , " + \`",
                       rowNames[2], "\`*", ageInput, " + \`",
                       rowNames[3], "\`*", ageInput2, " - \`",
                       rowNames[2], ":", rowNames[rowIndex],"\`*",ageInput , " - \`",
                       rowNames[3], ":", rowNames[rowIndex],"\`*",ageInput2 ))
            }

            res <- lapply( c( paste0(rowNames[1], " + ",
                                                rowNames[2], "*", ageInput," + \`",
                                                rowNames[3], "\`*", ageInput2),
                                         equations),
                           function(X) deltaMethod(fit(),  X))%>%
              do.call(rbind,.)

           } else if(modelType() == "Cubic"){
             if(input$varType == "cat"){
               equations <- sapply(1:(n-1), function(i){
                 paste0(rowNames[1], " + ",
                        rowNames[rowIndex[i]] , " + \`",
                        rowNames[2], "\`*", ageInput, " + \`",
                        rowNames[3], "\`*", ageInput2, " + \`",
                        rowNames[4], "\`*", ageInput3,  " + \`",
                        rowNames[2], ":", rowNames[rowIndex[i]],"\`*",ageInput , " + \`",
                        rowNames[3], ":", rowNames[rowIndex[i]],"\`*",ageInput2 , " + \`",
                        rowNames[4], ":", rowNames[rowIndex[i]],"\`*",ageInput3)
               })

             }else if(input$varType == "cont"){
               equations <-
                 c(paste0(rowNames[1], " + ",
                        rowNames[rowIndex] , " + \`",
                        rowNames[2], "\`*", ageInput, " + \`",
                        rowNames[3], "\`*", ageInput2, " + \`",
                        rowNames[4], "\`*", ageInput3,  " + \`",
                        rowNames[2], ":", rowNames[rowIndex],"\`*",ageInput , " + \`",
                        rowNames[3], ":", rowNames[rowIndex],"\`*",ageInput2 , " + \`",
                        rowNames[4], ":", rowNames[rowIndex],"\`*",ageInput3),
                   paste0(rowNames[1], " - ",
                          rowNames[rowIndex] , " + \`",
                          rowNames[2], "\`*", ageInput, " + \`",
                          rowNames[3], "\`*", ageInput2, " + \`",
                          rowNames[4], "\`*", ageInput3,  " - \`",
                          rowNames[2], ":", rowNames[rowIndex],"\`*",ageInput , " - \`",
                          rowNames[3], ":", rowNames[rowIndex],"\`*",ageInput2 , " - \`",
                          rowNames[4], ":", rowNames[rowIndex],"\`*",ageInput3 ))

             }

             res <- lapply( c( paste0(rowNames[1], " + \`",
                                                 rowNames[2], "\`*", ageInput," + \`",
                                                 rowNames[3], "\`*", ageInput2,  " + \`",
                                                 rowNames[4], "\`*", ageInput3),
                                          equations),
                            function(X) deltaMethod(fit(),  X))%>%
               do.call(rbind,.)

           } else if(modelType() == "Quartic"){
             if(input$varType == "cat"){
               equations <- sapply(1:(n-1), function(i){
                 paste0(rowNames[1], " + ",
                        rowNames[rowIndex[i]] , " + \`",
                        rowNames[2], "\`*", ageInput, " + \`",
                        rowNames[3], "\`*", ageInput2, " + \`",
                        rowNames[4], "\`*", ageInput3,  " + \`",
                        rowNames[5], "\`*", ageInput4,  " + \`",
                        rowNames[2], ":", rowNames[rowIndex[i]],"\`*",ageInput , " + \`",
                        rowNames[3], ":", rowNames[rowIndex[i]],"\`*",ageInput2 , " + \`",
                        rowNames[4], ":", rowNames[rowIndex[i]],"\`*",ageInput3 , " + \`",
                        rowNames[5], ":", rowNames[rowIndex[i]],"\`*",ageInput4 )
               })

             }else if(input$varType == "cont"){
               equations <- c(
                 paste0(rowNames[1], " + ",
                        rowNames[rowIndex] , " + \`",
                        rowNames[2], "\`*", ageInput, " + \`",
                        rowNames[3], "\`*", ageInput2, " + \`",
                        rowNames[4], "\`*", ageInput3,  " + \`",
                        rowNames[5], "\`*", ageInput4,  " + \`",
                        rowNames[2], ":", rowNames[rowIndex],"\`*",ageInput , " + \`",
                        rowNames[3], ":", rowNames[rowIndex],"\`*",ageInput2 , " + \`",
                        rowNames[4], ":", rowNames[rowIndex],"\`*",ageInput3 , " + \`",
                        rowNames[5], ":", rowNames[rowIndex],"\`*",ageInput4 ),
                 paste0(rowNames[1], " - ",
                        rowNames[rowIndex] , " + \`",
                        rowNames[2], "\`*", ageInput, " + \`",
                        rowNames[3], "\`*", ageInput2, " + \`",
                        rowNames[4], "\`*", ageInput3,  " + \`",
                        rowNames[5], "\`*", ageInput4,  " - \`",
                        rowNames[2], ":", rowNames[rowIndex],"\`*",ageInput , " - \`",
                        rowNames[3], ":", rowNames[rowIndex],"\`*",ageInput2 , " - \`",
                        rowNames[4], ":", rowNames[rowIndex],"\`*",ageInput3 , " - \`",
                        rowNames[5], ":", rowNames[rowIndex],"\`*",ageInput4 ))
             }

             res <- lapply(c( paste0(rowNames[1], " + \`",
                                                   rowNames[2], "\`*", ageInput," + \`",
                                                   rowNames[3], "\`*", ageInput2,  " + \`",
                                                   rowNames[4], "\`*", ageInput3,  " + \`",
                                                   rowNames[5], "\`*", ageInput4),
                                            equations),
                           function(X) deltaMethod(fit(),  X))%>%
               do.call(rbind,.)
          }

          # --------------------
          # Tidy results dataframe and rename rows/columns
          res <- data.frame(estimate = res$Estimate,
                            conf.low = res$`2.5 %`,
                            conf.high = res$`97.5 %`)

          rowname <- paste0("Score (", traj(), ")")

          if(input$varType == "cat"){
          levelNames <- as.character(levels(as.factor(pull(modelDataEdit(), !!sym(input$condition)))))

          rownames(res) <- paste0(rowname, " [", input$condition, ", level = ", levelNames, " ] (95% CIs)")

          }else if(input$varType == "cont"){
            rownames(res) <- paste0(paste0(rowname, " [", input$condition, " ] "), c("Population Average", "+ 1 SD", "- 1 SD"))
          }

          return( res )
        })
        return(score)
      })

      # ------------------------------------------
      # Plot the score at the given age

      plotScoreAll <- eventReactive(c(input$ageInputScore,input$button), {


          req(score_glht())

          estimate <- lapply(score_glht(), function(df) {
            df %>%
              dplyr::select(estimate)
          })  %>% do.call(cbind, .)
          colnames(estimate) <- input$ageInputScore
          if(!is.null(estimate)){
            estimate <- estimate %>%
              gather(age, score, 1:ncol(estimate)) %>%
              mutate(age = as.numeric(age))

            conf.low <- lapply(score_glht(), function(df) {df %>% dplyr::select(conf.low)}) %>% do.call(cbind, .)
            colnames(conf.low) <- input$ageInputScore
            conf.low  <- conf.low %>%
              gather(age, conf.low, 1:ncol(conf.low)) %>%
              mutate(age = as.numeric(age))

            conf.high <- lapply(score_glht(), function(df) {df %>% dplyr::select(conf.high)}) %>% do.call(cbind, .)
            colnames(conf.high) <- input$ageInputScore
            conf.high  <- conf.high %>%
              gather(age, conf.high, 1:ncol(conf.high)) %>%
              mutate(age = as.numeric(age))%>%
              dplyr::select(-age)

            conf <- cbind(conf.low, conf.high, "age")

            if(input$varType == "cat"){
              ggplot() +
                geom_line(data = modelDataEdit(), aes(x= age_original ,  y = pred, color = !!sym(input$condition) ) , na.rm=T) +
                theme(legend.text = element_text(color = "black")) +
                geom_errorbar(data = conf, aes(x = age, ymin = conf.low, ymax = conf.high), width = 0.5) +
                geom_point(data = estimate, aes(x = age, y = score), col = "#1D86C7", size = 5) +
                ylab(paste0("Score (", traj(), ")")) +
                xlab("Age")
            }else if(input$varType == "cont"){
              ggplot() +
                geom_line(data = modelDataEdit(), aes(x= age_original ,  y = pred, color = "Population Average" ) , linewidth = 1.5, na.rm=T)+
                geom_line(data = modelDataEdit(), aes(x= age_original ,  y = plus, color = "+ 1 SD" ) , na.rm=T)+
                geom_line(data = modelDataEdit(), aes(x= age_original ,  y = minus, color = "- 1 SD" ) , na.rm=T) +
                theme(legend.text = element_text(color = "black"))+
                geom_errorbar(data = conf, aes(x = age, ymin = conf.low, ymax = conf.high), width = 0.5) +
                geom_point(data = estimate, aes(x = age, y = score), col = "#1D86C7", size = 5) +
                labs(color = "") +
                scale_color_manual(
                  breaks = c("+ 1 SD", "Population Average", "- 1 SD"),
                  values = c("#d55e00", "black", "#0072b2")) +
                ylab(paste0("Score (", traj(), ")")) +
                xlab("Age")
            }
          }

      })
      output$plotScore <- renderPlot({
        plotScoreAll()
      })

      # ------------------------------------------
      # Return a table of the score for all the ages
      # --- Age | Score
      # Change "Score" to the actual column name from the dataframe - which the user previously specified
      tableScoreAll <- eventReactive(c(input$ageInputScore,input$button), {
          req(score_glht())

          estimateCI <- lapply(score_glht(), function(df) {
            df %>%
              mutate(estimateCI = paste0(round(estimate,3) , " (", round(conf.low,3) , " - ", round(conf.high,3) , ")")) %>%
              dplyr::select(estimateCI)
          })  %>% do.call(cbind, .)
          colnames(estimateCI) <- input$ageInputScore
          estimateCI
      })

      output$tableScore <- renderTable({
        tableScoreAll()
      }, colnames =TRUE, rownames = TRUE)

      # ------------------------------------------
      # Difference in scores at ages (with 95% CIs)

      # User select which 2 levels of their factor they want to see a difference between
      # if input var is categorical
      output$levelsScoresUI <- renderUI({
        if(input$varType == "cat"){
          if(length(unique(pull(modelDataEdit(), !!sym(input$condition)))) > 2){
            selectizeInput(ns("levelsScores"), "Select two levels from your factor to calculate the difference in scores:",
                           sort(unique(pull(modelDataEdit(), !!sym(input$condition)))),
                           multiple = TRUE,
                           options = list(maxItems = 2))
          }else if(length(unique(pull(modelDataEdit(), !!sym(input$condition)))) == 2){
            selectizeInput(ns("levelsScores"), "Select two levels from your factor to calculate the difference in scores:",
                           sort(unique(pull(modelDataEdit(), !!sym(input$condition)))),
                           multiple = TRUE,
                           options = list(maxItems = 2),
                           selected = sort(unique(pull(modelDataEdit(), !!sym(input$condition)))))
          }
        }else{

        }
      })

      differenceScores <- reactive({
        if(input$varType == "cat" & length(input$levelsScores == 2)){

          ageOrig <- modelDataEdit() %>% pull(age_original)
          ageOrig <- ageOrig[!is.na(ageOrig)]

          statements <- lapply(as.numeric(input$ageInputScore), function(x){
            ageInput <- round(x - mean(ageOrig), 3)
            ageInput2 <- ageInput^2
            ageInput3 <- ageInput^3
            ageInput4 <- ageInput^4

            coef <- summary(fit())$coefficients

            rowIndex <- which(str_detect(string = row.names(coef),
                                         pattern = input$condition) &
                                str_detect(string = row.names(coef),
                                           pattern = ":", negate = T))

            rowNames <- rownames(coef) %>%
              str_remove_all("I|\\(|\\^|\\)|\\:")

            levelNames <- paste0(input$condition,input$levelsScores) %>%
              str_remove_all("I|\\(|\\^|\\)|\\:")

            if( sum(str_detect(rowNames, levelNames[1])) == sum(str_detect(rowNames, levelNames[2])) ){

              levelNames1 <- rowNames[str_detect(rowNames, levelNames[1])]
              levelNames2 <- rowNames[str_detect(rowNames, levelNames[2])]

              if(modelType() == "Linear"){

                res <- deltaMethod(fit(), c(paste0(
                  "(", rowNames[1], " + ", rowNames[2], "*", ageInput, " + ", levelNames1[1], " + ", levelNames1[2], "*", ageInput, ") - (",rowNames[1], " + ", rowNames[2], "*", ageInput, " + ", levelNames2[1], " + ", levelNames2[2], "*", ageInput, ")"
                )), parameterNames = rowNames )

              }else if(modelType() == "Quadratic"){
                res <- deltaMethod(fit(), c(paste0(
                  "(", rowNames[1], " + ", rowNames[2], "*", ageInput, " + ", rowNames[3], "*", ageInput2, " + ", levelNames1[1], " + ", levelNames1[2], "*", ageInput, " + ", levelNames1[3], "*", ageInput2,  ") - (", rowNames[1], " + ", rowNames[2], "*", ageInput, " + ", rowNames[3], "*", ageInput2, " + ", levelNames2[1], " + ", levelNames2[2], "*", ageInput, " + ", levelNames2[3], "*", ageInput2,  ")"
                )), parameterNames = rowNames )

              }else if(modelType() == "Cubic"){
                res <- deltaMethod(fit(), c(paste0(
                  "(", rowNames[1], " + ", rowNames[2], "*", ageInput, " + ", rowNames[3], "*", ageInput2, " + ", rowNames[4], "*", ageInput3, " + ", levelNames1[1], " + ", levelNames1[2], "*", ageInput, " + ", levelNames1[3], "*", ageInput2, " + ", levelNames1[4], "*", ageInput3,  ") - (", rowNames[1], " + ", rowNames[2], "*", ageInput, " + ", rowNames[3], "*", ageInput2, " + ", rowNames[4], "*", ageInput3, " + ", levelNames2[1], " + ", levelNames2[2], "*", ageInput, " + ", levelNames2[3], "*", ageInput2, " + ", levelNames2[4], "*", ageInput3,  ")"
                )), parameterNames = rowNames )

              }else if(modelType() == "Quartic"){
                res <- deltaMethod(fit(), c(paste0(
                  "(", rowNames[1], " + ", rowNames[2], "*", ageInput, " + ", rowNames[3], "*", ageInput2, " + ", rowNames[4], "*", ageInput3, " + ", rowNames[5], "*", ageInput4, " + ", levelNames1[1], " + ", levelNames1[2], "*", ageInput, " + ", levelNames1[3], "*", ageInput2, " + ", levelNames1[4], "*", ageInput3, " + ", levelNames1[5], "*", ageInput4,  ") - (", rowNames[1], " + ", rowNames[2], "*", ageInput, " + ", rowNames[3], "*", ageInput2, " + ", rowNames[4], "*", ageInput3, " + ", rowNames[5], "*", ageInput4, " + ", levelNames2[1], " + ", levelNames2[2], "*", ageInput, " + ", levelNames2[3], "*", ageInput2, " + ", levelNames2[4], "*", ageInput3, " + ", levelNames2[5], "*", ageInput4,  ")"
                )), parameterNames = rowNames )
              }

            }else{
              levelNames1 <- rowNames[str_detect(rowNames, paste0(levelNames, collapse = "|"))]

              if(modelType() == "Linear"){

                res <- deltaMethod(fit(), c(paste0(
                  "(", rowNames[1], " + ", rowNames[2], "*", ageInput, " + ", levelNames1[1], " + ", levelNames1[2], "*", ageInput, ") - (",rowNames[1], " + ", rowNames[2], "*", ageInput, ")"
                )), parameterNames = rowNames )

              }else if(modelType() == "Quadratic"){
                res <- deltaMethod(fit(), c(paste0(
                  "(", rowNames[1], " + ", rowNames[2], "*", ageInput, " + ", rowNames[3], "*", ageInput2, " + ", levelNames1[1], " + ", levelNames1[2], "*", ageInput, " + ", levelNames1[3], "*", ageInput2,  ") - (", rowNames[1], " + ", rowNames[2], "*", ageInput, " + ", rowNames[3], "*", ageInput2,  ")"
                )), parameterNames = rowNames )

              }else if(modelType() == "Cubic"){
                res <- deltaMethod(fit(), c(paste0(
                  "(", rowNames[1], " + ", rowNames[2], "*", ageInput, " + ", rowNames[3], "*", ageInput2, " + ", rowNames[4], "*", ageInput3, " + ", levelNames1[1], " + ", levelNames1[2], "*", ageInput, " + ", levelNames1[3], "*", ageInput2, " + ", levelNames1[4], "*", ageInput3,  ") - (", rowNames[1], " + ", rowNames[2], "*", ageInput, " + ", rowNames[3], "*", ageInput2, " + ", rowNames[4], "*", ageInput3,  ")"
                )), parameterNames = rowNames )

              }else if(modelType() == "Quartic"){
                res <- deltaMethod(fit(), c(paste0(
                  "(", rowNames[1], " + ", rowNames[2], "*", ageInput, " + ", rowNames[3], "*", ageInput2, " + ", rowNames[4], "*", ageInput3, " + ", rowNames[5], "*", ageInput4, " + ", levelNames1[1], " + ", levelNames1[2], "*", ageInput, " + ", levelNames1[3], "*", ageInput2, " + ", levelNames1[4], "*", ageInput3, " + ", levelNames1[5], "*", ageInput4,  ") - (", rowNames[1], " + ", rowNames[2], "*", ageInput, " + ", rowNames[3], "*", ageInput2, " + ", rowNames[4], "*", ageInput3, " + ", rowNames[5], "*", ageInput4,   ")"
                )), parameterNames = rowNames )
              }

            }

            dif <- paste0( round(res$Estimate, 3), " (", round(res$`2.5 %`,3), " - ", round(res$`97.5 %`,3), ")")
            res <- data.frame(age = dif)
            return(res)
          })
          return(statements)
        }else if(input$varType == "cont"){
          # Calculate difference in scores between +1 SD and -1SD
          ageOrig <- modelDataEdit() %>% pull(age_original)
          ageOrig <- ageOrig[!is.na(ageOrig)]

          statements <- lapply(as.numeric(input$ageInputScore), function(x){
            ageInput <- round(x - mean(ageOrig), 3)
            ageInput2 <- ageInput^2
            ageInput3 <- ageInput^3
            ageInput4 <- ageInput^4

            coef <- summary(fit())$coefficients

            rowIndex <- which(str_detect(string = row.names(coef),
                                         pattern = input$condition) &
                                str_detect(string = row.names(coef),
                                           pattern = ":", negate = T))

            rowNames <- rownames(coef) %>%
              str_remove_all("I|\\(|\\^|\\)|\\:")

            levelNames <- paste0(input$condition) %>%
              str_remove_all("I|\\(|\\^|\\)|\\:")

            levelNames1 <- rowNames[str_detect(rowNames, paste0(levelNames, collapse = "|"))]

          if(modelType() == "Linear"){
            res <- deltaMethod(fit(), c(paste0(
              "(", rowNames[1], " + ", rowNames[2], "*", ageInput, " + ", levelNames1[1], " + ", levelNames1[2], "*", ageInput, ") -
    (",  rowNames[1], " + ", rowNames[2], "*", ageInput, " - ", levelNames1[1], " - ", levelNames1[2], "*", ageInput  , ")"
            )), parameterNames = rowNames )
          }else if(modelType() == "Quadratic"){
            res <- deltaMethod(fit(), c(paste0(
              "(", rowNames[1], " + ", rowNames[2], "*", ageInput, " + ", rowNames[3], "*", ageInput2, " + ", levelNames1[1], " + ", levelNames1[2], "*", ageInput, " + ", levelNames1[3], "*", ageInput2,  ") - (", rowNames[1], " + ", rowNames[2], "*", ageInput, " + ", rowNames[3], "*", ageInput2, " - ", levelNames1[1], " - ", levelNames1[2], "*", ageInput, " - ", levelNames1[3], "*", ageInput2,  ")"
            )), parameterNames = rowNames )

          }else if(modelType() == "Cubic"){
            res <- deltaMethod(fit(), c(paste0(
              "(", rowNames[1], " + ", rowNames[2], "*", ageInput, " + ", rowNames[3], "*", ageInput2, " + ", rowNames[4], "*", ageInput3, " + ", levelNames1[1], " + ", levelNames1[2], "*", ageInput, " + ", levelNames1[3], "*", ageInput2, " + ", levelNames1[4], "*", ageInput3,  ") -  (", rowNames[1], " + ", rowNames[2], "*", ageInput, " + ", rowNames[3], "*", ageInput2, " + ", rowNames[4], "*", ageInput3, " - ", levelNames1[1], " - ", levelNames1[2], "*", ageInput, " - ", levelNames1[3], "*", ageInput2, " - ", levelNames1[4], "*", ageInput3,  ")"
            )), parameterNames = rowNames )

          }else if(modelType() == "Quartic"){
            res <- deltaMethod(fit(), c(paste0(
              "(", rowNames[1], " + ", rowNames[2], "*", ageInput, " + ", rowNames[3], "*", ageInput2, " + ", rowNames[4], "*", ageInput3, " + ", rowNames[5], "*", ageInput4, " + ", levelNames1[1], " + ", levelNames1[2], "*", ageInput, " + ", levelNames1[3], "*", ageInput2, " + ", levelNames1[4], "*", ageInput3, " + ", levelNames1[5], "*", ageInput4,  ") - (", rowNames[1], " + ", rowNames[2], "*", ageInput, " + ", rowNames[3], "*", ageInput2, " + ", rowNames[4], "*", ageInput3, " + ", rowNames[5], "*", ageInput4, " - ", levelNames1[1], " - ", levelNames1[2], "*", ageInput, " - ", levelNames1[3], "*", ageInput2, " - ", levelNames1[4], "*", ageInput3, " - ", levelNames1[5], "*", ageInput4,   ")"
            )), parameterNames = rowNames )
          }
          dif <- paste0( round(res$Estimate, 3), " (", round(res$`2.5 %`,3), " - ", round(res$`97.5 %`,3), ")")
          res <- data.frame(age = dif)
          return(res)
          }) # end of lapply for creating statements
          return(statements)
        }else{
          return(NULL)
        }
      })

      difTab <- reactive({
        if(input$varType == "cat" & length(input$levelsScores == 2)){
        difTab <- do.call(cbind, differenceScores())
        colnames(difTab) <- input$ageInputScore
        rownames(difTab) <- paste0("Difference between ",input$levelsScores[1]," and ", input$levelsScores[2]," (95% CI)")
        difTab
        }else if(input$varType == "cont"){
          difTab <- do.call(cbind, differenceScores())
          colnames(difTab) <- input$ageInputScore
          rownames(difTab) <- paste0("Difference between +1 SD and  -1 SD (95% CI)")
          difTab
        }else{
          data.frame(NA)
        }
      })

      output$scoresDif <- renderTable({
        if(input$varType == "cat" & length(input$levelsScores == 2) | input$varType == "cont"){
        difTab()
        }
      }, rownames = TRUE)


      # ------------------------------------------
      ###############################################################
      # --- AUC tab ------
      ###############################################################

      # ------------------------------------------
      # Overview of what AUC does text
      output$AUCoverview <- renderText({
        paste0('The area under the curve (AUC) represents the cumulative or total "exposure" to the outcome (', traj(), ') over the time period being measured.')
      })

      # ------------------------------------------
      # Make age slider for user
      output$AUCagesUI <- renderUI({
        ageOrig <- modelDataEdit() %>%
          pull(age_original)
        ageOrig <- ageOrig[!is.na(ageOrig)]

        sliderInput(ns("AUCages"),
                    "Select the age range to calculate AUC for:",
                    min = round(min(ageOrig, na.rm =T)),
                    max = round(max(ageOrig, na.rm =T)),
                    value = c(round(min(ageOrig, na.rm =T)),round(max(ageOrig, na.rm =T)))
        )
      })

      # ------------------------------------------
      # Calculate the AUC for the ages the user has chosen for the chosen input$condition levels
      # ------------------------------------------
      # New method:
      AUC_delta <- reactive({

        coef <- summary(fit())$coefficients

        ageOrig <- modelDataEdit() %>%
          pull(age_original)
        ageOrig <- ageOrig[!is.na(ageOrig)]
        age1 <- input$AUCages[1] - mean(ageOrig)
        age2 <- input$AUCages[2] - mean(ageOrig)

        rowNames <- rownames(coef) %>%
          str_remove_all("I|\\(|\\^|\\)|\\:")

        AUC <-
          if(modelType() == "Linear"){
            deltaMethod(fit(), c( paste0("(((", age2, ")*(", rowNames[1], ")) + ((", rowNames[2], ")*(", age2, ")^2/2)) - (((", age1,")*(", rowNames[1], ")) + ((", rowNames[2], ")*(", age1, ")^2/2))") ) , parameterNames = rowNames)
          } else if(modelType() == "Quadratic"){
            deltaMethod(fit(), c( paste0("(((", age2, ")*(", rowNames[1], ")) + ((", rowNames[2], ")*(", age2, ")^2/2) + ((", rowNames[3], ")*(", age2, ")^3/3)) - (((", age1,")*(", rowNames[1], ")) + ((", rowNames[2], ")*(", age1, ")^2/2) + ((", rowNames[3], ")*(", age1, ")^3/3))") ), parameterNames = rowNames )
          } else if(modelType() == "Cubic"){
            deltaMethod(fit(), c( paste0("(((", age2, ")*(", rowNames[1], ")) + ((", rowNames[2], ")*(", age2, ")^2/2) + ((", rowNames[3], ")*(", age2, ")^3/3) + ((", rowNames[4], ")*(", age2, ")^4/4)) - (((", age1,")*(", rowNames[1], ")) + ((", rowNames[2], ")*(", age1, ")^2/2) + ((", rowNames[3], ")*(", age1, ")^3/3) + ((", rowNames[4], ")*(", age1, ")^4/4))") ), parameterNames = rowNames )
          } else if(modelType() == "Quartic"){
            deltaMethod(fit(), c( paste0("(((", age2, ")*(", rowNames[1], ")) + ((", rowNames[2], ")*(", age2, ")^2/2) + ((", rowNames[3], ")*(", age2, ")^3/3) + ((", rowNames[4], ")*(", age2, ")^4/4) + ((", rowNames[5], ")*(", age2, ")^5/5)) - (((", age1,")*(", rowNames[1], ")) + ((", rowNames[2], ")*(", age1, ")^2/2) + ((", rowNames[3], ")*(", age1, ")^3/3) + ((", rowNames[4], ")*(", age1, ")^4/4) + ((", rowNames[5], ")*(", age1, ")^5/5))") ), parameterNames = rowNames )
          }
        AUC <- paste0( abs(round(AUC$Estimate, 2)), " (", abs(round(AUC$`2.5 %`,2)), " - ", abs(round(AUC$`97.5 %`,2)), ")")


      rowIndex <- which(str_detect(string = row.names(summary(fit())$coefficients),
                                   pattern = input$condition) &
                          str_detect(string = row.names(summary(fit())$coefficients),
                                     pattern = ":", negate = T))

      rowIndexInteract1 <- which(str_detect(string = row.names(summary(fit())$coefficients),
                                            pattern = input$condition) &
                                   str_detect(string = row.names(summary(fit())$coefficients),
                                              pattern = ":") &
                                   str_detect(string = row.names(summary(fit())$coefficients),
                                              pattern = "\\^", negate = T))

      rowIndexInteract2 <- which(str_detect(string = row.names(summary(fit())$coefficients),
                                            pattern = input$condition) &
                                   str_detect(string = row.names(summary(fit())$coefficients),
                                              pattern = ":") &
                                   str_detect(string = row.names(summary(fit())$coefficients),
                                              pattern = "\\^2"))

      rowIndexInteract3 <- which(str_detect(string = row.names(summary(fit())$coefficients),
                                            pattern = input$condition) &
                                   str_detect(string = row.names(summary(fit())$coefficients),
                                              pattern = ":") &
                                   str_detect(string = row.names(summary(fit())$coefficients),
                                              pattern = "\\^3"))

      rowIndexInteract4 <- which(str_detect(string = row.names(summary(fit())$coefficients),
                                            pattern = input$condition) &
                                   str_detect(string = row.names(summary(fit())$coefficients),
                                              pattern = ":") &
                                   str_detect(string = row.names(summary(fit())$coefficients),
                                              pattern = "\\^4"))

      if(input$varType == "cat"){
        n <- length(unique(pull(modelDataScaled(), !!sym(input$condition))))

        AUCCovs <- lapply(1:(n-1), function(i){
          if(modelType() == "Linear"){

            AUC <- deltaMethod(fit(),
                               c( paste0(
                                 "(((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2) + ((",rowNames[rowIndex[i]],")*(",age2,")) + ((",rowNames[rowIndexInteract1[i]],")*(",age2,")^2/2) ) -
                                   (((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[rowIndex[i]],")*(",age1,")) + ((",rowNames[rowIndexInteract1[i]],")*(",age1,")^2/2) )"
                               ) )
                               , parameterNames = rowNames )

          } else if(modelType() == "Quadratic"){

            AUC <- deltaMethod(fit(),
                               c( paste0(
                                 "(((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2) + ((",rowNames[3],")*(",age2,")^3/3) + ((",rowNames[rowIndex[i]],")*(",age2,")) + ((",rowNames[rowIndexInteract1[i]],")*(",age2,")^2/2) + ((",rowNames[rowIndexInteract2[i]],")*(",age2,")^3/3) ) -
              (((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[3],")*(",age1,")^3/3) + ((",rowNames[rowIndex[i]],")*(",age1,")) + ((",rowNames[rowIndexInteract1[i]],")*(",age1,")^2/2) + ((",rowNames[rowIndexInteract2[i]],")*(",age1,")^3/3) )"
                               ) )
                               , parameterNames = rowNames )

          } else if(modelType() == "Cubic"){

            AUC <- deltaMethod(fit(),
                               c( paste0(
                                 "(((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2) + ((",rowNames[3],")*(",age2,")^3/3) + ((",rowNames[4],")*(",age2,")^4/4) + ((",rowNames[rowIndex[i]],")*(",age2,")) + ((",rowNames[rowIndexInteract1[i]],")*(",age2,")^2/2) + ((",rowNames[rowIndexInteract2[i]], ")*(",age2,")^3/3) + ((",rowNames[rowIndexInteract3[i]], ")*(", age2, ")^4/4) ) -
                                 (((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[3],")*(",age1,")^3/3) + ((",rowNames[4],")*(",age1,")^4/4) + ((",rowNames[rowIndex[i]],")*(",age1,")) + ((",rowNames[rowIndexInteract1[i]],")*(",age1,")^2/2) + ((",rowNames[rowIndexInteract2[i]], ")*(",age1,")^3/3) + ((",rowNames[rowIndexInteract3[i]], ")*(", age1, ")^4/4) )"
                               ) )
                               , parameterNames = rowNames )

          } else if(modelType() == "Quartic"){

            AUC <- deltaMethod(fit(),
                               c( paste0(
                                 "(((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2) + ((",rowNames[3],")*(",age2,")^3/3) + ((",rowNames[4],")*(",age2,")^4/4) + ((",rowNames[5],")*(",age2,")^5/5) + ((",rowNames[rowIndex[i]],")*(",age2,")) + ((",rowNames[rowIndexInteract1[i]],")*(",age2,")^2/2) + ((",rowNames[rowIndexInteract2[i]], ")*(",age2,")^3/3) + ((",rowNames[rowIndexInteract3[i]], ")*(", age2, ")^4/4)  + ((",rowNames[rowIndexInteract4[i]], ")*(", age2, ")^5/5)) -
                                 (((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[3],")*(",age1,")^3/3) + ((",rowNames[4],")*(",age1,")^4/4) + ((",rowNames[5],")*(",age1,")^5/5) + ((",rowNames[rowIndex[i]],")*(",age1,")) + ((",rowNames[rowIndexInteract1[i]],")*(",age1,")^2/2) + ((",rowNames[rowIndexInteract2[i]], ")*(",age1,")^3/3) + ((",rowNames[rowIndexInteract3[i]], ")*(", age1, ")^4/4) + ((",rowNames[rowIndexInteract4[i]], ")*(", age1, ")^5/5) )"
                               ) )
                               , parameterNames = rowNames )

          }
          AUC <- paste0( abs(round(AUC$Estimate, 2)), " (", abs(round(AUC$`2.5 %`,2)), " - ", abs(round(AUC$`97.5 %`,2)), ")")
        })
        return( list(AUC = AUC, AUCCovs = AUCCovs) )

      }else if(input$varType == "cont"){

        # continuous variable, calculate AUC ±1 sd
        AUC_SD <-
          if(modelType() == "Linear"){

            plus <- deltaMethod(fit(),
                               c( paste0(
                                 "(((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2) + ((",rowNames[rowIndex],")*(",age2,")) + ((",rowNames[rowIndexInteract1],")*(",age2,")^2/2) ) -
                                   (((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[rowIndex],")*(",age1,")) + ((",rowNames[rowIndexInteract1],")*(",age1,")^2/2) )"
                               ) )
                               , parameterNames = rowNames )

            minus <- deltaMethod(fit(),
                                c( paste0(
                                  "(((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2) - ((",rowNames[rowIndex],")*(",age2,")) - ((",rowNames[rowIndexInteract1],")*(",age2,")^2/2) ) -
                                   (((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) - ((",rowNames[rowIndex],")*(",age1,")) - ((",rowNames[rowIndexInteract1],")*(",age1,")^2/2) )"
                                ) )
                                , parameterNames = rowNames )

            c(paste0( abs(round(plus$Estimate, 2)), " (", abs(round(plus$`2.5 %`,2)), " - ", abs(round(plus$`97.5 %`,2)), ")"),
              paste0( abs(round(minus$Estimate, 2)), " (", abs(round(minus$`2.5 %`,2)), " - ", abs(round(minus$`97.5 %`,2)), ")"))

          } else if(modelType() == "Quadratic"){

            plus <- deltaMethod(fit(),
                                c( paste0(
                                  "(((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2) + ((",rowNames[3],")*(",age2,")^3/3) + ((",rowNames[rowIndex],")*(",age2,")) + ((",rowNames[rowIndexInteract1],")*(",age2,")^2/2) + ((",rowNames[rowIndexInteract2],")*(",age2,")^3/3)) -
                                   (((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[3],")*(",age1,")^3/3) + ((",rowNames[rowIndex],")*(",age1,")) + ((",rowNames[rowIndexInteract1],")*(",age1,")^2/2) + ((",rowNames[rowIndexInteract2],")*(",age1,")^3/3) )"
                                ) )
                                , parameterNames = rowNames )

            minus <- deltaMethod(fit(),
                                 c( paste0(
                                   "(((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2) + ((",rowNames[3],")*(",age2,")^3/3) - ((",rowNames[rowIndex],")*(",age2,")) - ((",rowNames[rowIndexInteract1],")*(",age2,")^2/2) - ((",rowNames[rowIndexInteract2],")*(",age2,")^3/3)) -
                                   (((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[3],")*(",age1,")^3/3) - ((",rowNames[rowIndex],")*(",age1,")) - ((",rowNames[rowIndexInteract1],")*(",age1,")^2/2) - ((",rowNames[rowIndexInteract2],")*(",age1,")^3/3) )"
                                 ) )
                                 , parameterNames = rowNames )

            c(paste0( abs(round(plus$Estimate, 2)), " (", abs(round(plus$`2.5 %`,2)), " - ", abs(round(plus$`97.5 %`,2)), ")"),
              paste0( abs(round(minus$Estimate, 2)), " (", abs(round(minus$`2.5 %`,2)), " - ", abs(round(minus$`97.5 %`,2)), ")"))

          } else if(modelType() == "Cubic"){

            plus <- deltaMethod(fit(),
                                c( paste0(
                                  "(((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2) + ((",rowNames[3],")*(",age2,")^3/3) + ((",rowNames[4],")*(",age2,")^4/4) + ((",rowNames[rowIndex],")*(",age2,")) + ((",rowNames[rowIndexInteract1],")*(",age2,")^2/2) + ((",rowNames[rowIndexInteract2],")*(",age2,")^3/3) + ((",rowNames[rowIndexInteract3],")*(",age2,")^4/4) ) -
                                   (((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[3],")*(",age1,")^3/3) + ((",rowNames[4],")*(",age1,")^4/4) + ((",rowNames[rowIndex],")*(",age1,")) + ((",rowNames[rowIndexInteract1],")*(",age1,")^2/2) + ((",rowNames[rowIndexInteract2],")*(",age1,")^3/3) + ((",rowNames[rowIndexInteract3],")*(",age1,")^4/4) )"
                                ) )
                                , parameterNames = rowNames )

            minus <- deltaMethod(fit(),
                                 c( paste0(
                                   "(((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2) + ((",rowNames[3],")*(",age2,")^3/3) + ((",rowNames[4],")*(",age2,")^4/4) - ((",rowNames[rowIndex],")*(",age2,")) - ((",rowNames[rowIndexInteract1],")*(",age2,")^2/2) - ((",rowNames[rowIndexInteract2],")*(",age2,")^3/3) - ((",rowNames[rowIndexInteract3],")*(",age2,")^4/4) ) -
                                   (((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[3],")*(",age1,")^3/3) + ((",rowNames[4],")*(",age1,")^4/4) - ((",rowNames[rowIndex],")*(",age1,")) - ((",rowNames[rowIndexInteract1],")*(",age1,")^2/2) - ((",rowNames[rowIndexInteract2],")*(",age1,")^3/3) - ((",rowNames[rowIndexInteract3],")*(",age1,")^4/4) )"
                                 ) )
                                 , parameterNames = rowNames )

            c(paste0( abs(round(plus$Estimate, 2)), " (", abs(round(plus$`2.5 %`,2)), " - ", abs(round(plus$`97.5 %`,2)), ")"),
              paste0( abs(round(minus$Estimate, 2)), " (", abs(round(minus$`2.5 %`,2)), " - ", abs(round(minus$`97.5 %`,2)), ")"))

          } else if(modelType() == "Quartic"){

            plus <- deltaMethod(fit(),
                                c( paste0(
                                  "(((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2) + ((",rowNames[3],")*(",age2,")^3/3) + ((",rowNames[4],")*(",age2,")^4/4) + ((",rowNames[5],")*(",age2,")^5/5) + ((",rowNames[rowIndex],")*(",age2,")) + ((",rowNames[rowIndexInteract1],")*(",age2,")^2/2) + ((",rowNames[rowIndexInteract2],")*(",age2,")^3/3) + ((",rowNames[rowIndexInteract3],")*(",age2,")^4/4) + ((",rowNames[rowIndexInteract4],")*(",age2,")^5/5) ) -
                                   (((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[3],")*(",age1,")^3/3) + ((",rowNames[4],")*(",age1,")^4/4) + ((",rowNames[5],")*(",age1,")^5/5) + ((",rowNames[rowIndex],")*(",age1,")) + ((",rowNames[rowIndexInteract1],")*(",age1,")^2/2) + ((",rowNames[rowIndexInteract2],")*(",age1,")^3/3) + ((",rowNames[rowIndexInteract3],")*(",age1,")^4/4) + ((",rowNames[rowIndexInteract4],")*(",age1,")^5/5) )"
                                ) )
                                , parameterNames = rowNames )

            minus <- deltaMethod(fit(),
                                 c( paste0(
                                   "(((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2) + ((",rowNames[3],")*(",age2,")^3/3) + ((",rowNames[4],")*(",age2,")^4/4) + ((",rowNames[5],")*(",age2,")^5/5) - ((",rowNames[rowIndex],")*(",age2,")) - ((",rowNames[rowIndexInteract1],")*(",age2,")^2/2) - ((",rowNames[rowIndexInteract2],")*(",age2,")^3/3) - ((",rowNames[rowIndexInteract3],")*(",age2,")^4/4) - ((",rowNames[rowIndexInteract4],")*(",age2,")^5/5) ) -
                                   (((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[3],")*(",age1,")^3/3) + ((",rowNames[4],")*(",age1,")^4/4) + ((",rowNames[5],")*(",age1,")^5/5) - ((",rowNames[rowIndex],")*(",age1,")) - ((",rowNames[rowIndexInteract1],")*(",age1,")^2/2) - ((",rowNames[rowIndexInteract2],")*(",age1,")^3/3) - ((",rowNames[rowIndexInteract3],")*(",age1,")^4/4) - ((",rowNames[rowIndexInteract4],")*(",age1,")^5/5) )"
                                 ) )
                                 , parameterNames = rowNames )

            c(paste0( abs(round(plus$Estimate, 2)), " (", abs(round(plus$`2.5 %`,2)), " - ", abs(round(plus$`97.5 %`,2)), ")"),
              paste0( abs(round(minus$Estimate, 2)), " (", abs(round(minus$`2.5 %`,2)), " - ", abs(round(minus$`97.5 %`,2)), ")"))

          }
        return(list(AUCCont = AUC, AUC_SD = AUC_SD))
      }

      })

      # ------------------------------------------
      # Plot AUC
      plotAUC <- eventReactive(c(input$button, input$AUCages), {

        if(input$varType == "cat"){
          req(AUC_delta()$AUCCovs)

          ggplot(data = modelDataEdit()) +
            geom_ribbon(data = modelDataEdit(),
                        aes(x = age_original, ymax = pred, ymin = 0, fill = !!sym(input$condition)),
                        alpha = 0.1, show.legend = FALSE) +
            coord_cartesian(xlim = c(input$AUCages[1], input$AUCages[2])) +
            geom_line(aes(x = age_original, y = pred, color = !!sym(input$condition)), na.rm = TRUE) +
            theme(legend.text = element_text(color = "black")) +
            ylab(paste0("Score (", traj(), ")")) +
            xlab("Age") +
            scale_x_continuous(breaks = seq(round(min(modelDataEdit()$age_original, na.rm =T)), round(max(modelDataEdit()$age_original, na.rm =T)), by = 1),
                               expand = c(0, 0))+
            scale_y_continuous(expand = c(0, 0))


        }else if(input$varType == "cont"){

          req(AUC_delta()$AUCCont)
          ggplot() +
            geom_ribbon(data = modelDataEdit(),
                        aes(x = age_original, ymax = pred, ymin = 0),
                        alpha = 0.1, show.legend = FALSE, fill = "#1D86C7") +
            geom_line(data = modelDataEdit(), aes(x= age_original ,  y = pred ) , na.rm=T)+
            geom_line(data = modelDataEdit(), aes(x= age_original ,  y = plus, color = "+ 1 SD" ) , na.rm=T)+
            geom_line(data = modelDataEdit(), aes(x= age_original ,  y = minus, color = "- 1 SD" ) , na.rm=T)+
            coord_cartesian(xlim = c(input$AUCages[1], input$AUCages[2])) +
            labs(color = "") +
            theme(legend.text = element_text(color = "black")) +
            ylab(paste0("Score (", traj(), ")")) +
            xlab("Age") +
            scale_x_continuous(breaks = seq(round(min(modelDataEdit()$age_original, na.rm =T)), round(max(modelDataEdit()$age_original, na.rm =T)), by = 1),
                               expand = c(0, 0)) +
            scale_color_manual(
              breaks = c("+ 1 SD", "Population Average", "- 1 SD"),
              values = c("#d55e00", "black", "#0072b2")) +
            scale_y_continuous(expand = c(0, 0))
        }
      })

      output$AUCplot <- renderPlot({
        plotAUC()
      })


      tableAUC <- eventReactive(c(input$button, input$AUCages), {
        if(input$varType == "cat"){
          req(AUC_delta()$AUCCovs)
          df <- t(
            cbind(
              data.frame(paste0(input$AUCages[1], " - ", input$AUCages[2]),
                         AUC_delta()$AUC),
              do.call(cbind, AUC_delta()$AUCCovs)
            )
          )

          rowname <- paste0("AUC (", traj(), ")")
          levelNames <- as.character(levels(as.factor(pull(modelDataEdit(), input$condition))))
          rownames(df) <- c("Age Range", paste0(rowname, " [", input$condition, ", level = ", levelNames, " ] (95% CIs)") )
          df

        }else if(input$varType == "cont"){
          req(AUC_delta()$AUCCont)
          df <- t(
            data.frame(paste0(input$AUCages[1], " - ", input$AUCages[2]),
                       AUC_delta()$AUCCont,
                       AUC_delta()$AUC_SD[1],
                       AUC_delta()$AUC_SD[2])
          )
          rowname <- paste0(paste0("AUC (", traj(), ") [", input$condition, " ] (95% CIs) "), c("Population Average", "+ 1 SD", "- 1 SD")  )
          rownames(df) <- c("Age Range", rowname)
          df
        }
      })


      output$AUCtable <- renderTable({
        tableAUC()
      }, colnames = FALSE, rownames = TRUE)

      # ------
      # User select which 2 levels of their factor they want to see a difference between
      # if input var is categorical
      output$levelsAUCUI <- renderUI({
        if(input$varType == "cat"){
          if(length(unique(pull(modelDataEdit(), !!sym(input$condition)))) > 2){
            selectizeInput(ns("levelsAUC"), "Select two levels from your factor to calculate the difference in AUC between:",
                           sort(unique(pull(modelDataEdit(), !!sym(input$condition)))),
                           multiple = TRUE,
                           options = list(maxItems = 2))
          }else if(length(unique(pull(modelDataEdit(), !!sym(input$condition)))) == 2){
            selectizeInput(ns("levelsAUC"), "Select two levels from your factor to calculate the difference in AUC between:",
                           sort(unique(pull(modelDataEdit(), !!sym(input$condition)))),
                           multiple = TRUE,
                           options = list(maxItems = 2),
                           selected = sort(unique(pull(modelDataEdit(), !!sym(input$condition)))))
          }
        }else{

        }
      })


      difference <- reactive({
        if(input$varType == "cat" & length(input$levelsAUC == 2)){
        levelNames <- paste0(input$condition,input$levelsAUC) %>%
          str_remove_all("I|\\(|\\^|\\)|\\:")

        coef <- summary(fit())$coefficients

        ageOrig <- modelDataEdit() %>%
          pull(age_original)
        ageOrig <- ageOrig[!is.na(ageOrig)]
        age1 <- input$AUCages[1] - mean(ageOrig)
        age2 <- input$AUCages[2] - mean(ageOrig)

        rowNames <- rownames(coef) %>%
          str_remove_all("I|\\(|\\^|\\)|\\:")

        if( sum(str_detect(rowNames, levelNames[1])) == sum(str_detect(rowNames, levelNames[2])) ){

          levelNames1 <- rowNames[str_detect(rowNames, levelNames[1])]
          levelNames2 <- rowNames[str_detect(rowNames, levelNames[2])]

          if(modelType() == "Linear"){

          res <- deltaMethod(fit(), c( paste0(" (( ((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2)   + ( (",levelNames1[1],")*(",age2,") ) + ((",levelNames1[2],")*(",age2,")^2/2) ) - ( ((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2)   + ( (",levelNames1[1],")*(",age1,") ) + ((",levelNames1[2],")*(",age1,")^2/2) )) - (( ((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2)   + ( (",levelNames2[1],")*(",age2,") ) + ((",levelNames2[2],")*(",age2,")^2/2) ) - ( ((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2)   + ( (",levelNames2[1],")*(",age1,") ) + ((",levelNames2[2],")*(",age1,")^2/2) )) ") ) ,parameterNames = rowNames)

          }else if(modelType() == "Quadratic"){

            res <- deltaMethod(fit(), c( paste0(" (( ((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2)  + ((",rowNames[3],")*(",age2,")^3/3)   + ( (",levelNames1[1],")*(",age2,") ) + ((",levelNames1[2],")*(",age2,")^2/2) + ((",levelNames1[3],")*(",age2,")^3/3) ) - ( ((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[3],")*(",age1,")^3/3)  + ( (",levelNames1[1],")*(",age1,") ) + ((",levelNames1[2],")*(",age1,")^2/2) + ((",levelNames1[3],")*(",age1,")^3/3) )) - (( ((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2)   + ((",rowNames[3],")*(",age2,")^3/3)  + ( (",levelNames2[1],")*(",age2,") ) + ((",levelNames2[2],")*(",age2,")^2/2) + ((",levelNames2[3],")*(",age2,")^3/3) ) - ( ((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[3],")*(",age1,")^3/3)   + ( (",levelNames2[1],")*(",age1,") ) + ((",levelNames2[2],")*(",age1,")^2/2) + ((",levelNames2[3],")*(",age1,")^3/3) )) ") ) ,parameterNames = rowNames)

          }else if(modelType() == "Cubic"){

            res <- deltaMethod(fit(), c( paste0(" (( ((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2)  + ((",rowNames[3],")*(",age2,")^3/3) + ((",rowNames[4],")*(",age2,")^4/4)   + ( (",levelNames1[1],")*(",age2,") ) + ((",levelNames1[2],")*(",age2,")^2/2) + ((",levelNames1[3],")*(",age2,")^3/3) + ((",levelNames1[4],")*(",age2,")^4/4) ) - ( ((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[3],")*(",age1,")^3/3)  + ((",rowNames[4],")*(",age1,")^4/4)  + ( (",levelNames1[1],")*(",age1,") ) + ((",levelNames1[2],")*(",age1,")^2/2) + ((",levelNames1[3],")*(",age1,")^3/3) + ((",levelNames1[4],")*(",age1,")^4/4) )) - (( ((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2)   + ((",rowNames[3],")*(",age2,")^3/3)  + ((",rowNames[4],")*(",age2,")^4/4)  + ( (",levelNames2[1],")*(",age2,") ) + ((",levelNames2[2],")*(",age2,")^2/2) + ((",levelNames2[3],")*(",age2,")^3/3)  + ((",levelNames2[4],")*(",age2,")^4/4) ) - ( ((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[3],")*(",age1,")^3/3)  + ((",rowNames[4],")*(",age1,")^4/4)   + ( (",levelNames2[1],")*(",age1,") ) + ((",levelNames2[2],")*(",age1,")^2/2) + ((",levelNames2[3],")*(",age1,")^3/3) + ((",levelNames2[4],")*(",age1,")^4/4) )) ") ) ,parameterNames = rowNames)

          }else if(modelType() == "Quartic"){

            res <- deltaMethod(fit(), c( paste0(" (( ((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2)  + ((",rowNames[3],")*(",age2,")^3/3) + ((",rowNames[4],")*(",age2,")^4/4) + ((",rowNames[5],")*(",age2,")^5/5)   + ( (",levelNames1[1],")*(",age2,") ) + ((",levelNames1[2],")*(",age2,")^2/2) + ((",levelNames1[3],")*(",age2,")^3/3) + ((",levelNames1[4],")*(",age2,")^4/4)  + ((",levelNames1[5],")*(",age2,")^5/5) ) - ( ((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[3],")*(",age1,")^3/3)  + ((",rowNames[4],")*(",age1,")^4/4) + ((",rowNames[5],")*(",age1,")^5/5)  + ( (",levelNames1[1],")*(",age1,") ) + ((",levelNames1[2],")*(",age1,")^2/2) + ((",levelNames1[3],")*(",age1,")^3/3) + ((",levelNames1[4],")*(",age1,")^4/4) + ((",levelNames1[5],")*(",age1,")^5/5) )) -  (( ((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2)   + ((",rowNames[3],")*(",age2,")^3/3)  + ((",rowNames[4],")*(",age2,")^4/4) + ((",rowNames[5],")*(",age2,")^5/5)  + ( (",levelNames2[1],")*(",age2,") ) + ((",levelNames2[2],")*(",age2,")^2/2) + ((",levelNames2[3],")*(",age2,")^3/3)  + ((",levelNames2[4],")*(",age2,")^4/4) + ((",levelNames2[5],")*(",age2,")^5/5) ) - ( ((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[3],")*(",age1,")^3/3)  + ((",rowNames[4],")*(",age1,")^4/4)  + ((",rowNames[5],")*(",age1,")^5/5)   + ( (",levelNames2[1],")*(",age1,") ) + ((",levelNames2[2],")*(",age1,")^2/2) + ((",levelNames2[3],")*(",age1,")^3/3) + ((",levelNames2[4],")*(",age1,")^4/4)  + ((",levelNames2[5],")*(",age1,")^5/5) )) ") ) ,parameterNames = rowNames)

          }

        }else{
          levelNames1 <- rowNames[str_detect(rowNames, paste0(levelNames, collapse = "|"))]

          if(modelType() == "Linear"){
          res <- deltaMethod(fit(), c( paste0(" (( ((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2)   + ( (",levelNames1[1],")*(",age2,") ) + ((",levelNames1[2],")*(",age2,")^2/2) ) - ( ((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2)   + ( (",levelNames1[1],")*(",age1,") ) + ((",levelNames1[2],")*(",age1,")^2/2) )) - (( ((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2) ) - ( ((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2)     )) ") ) ,parameterNames = rowNames)
          }else if(modelType() == "Quadratic"){

          res <- deltaMethod(fit(), c( paste0(" (( ((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2)  + ((",rowNames[3],")*(",age2,")^3/3)   + ( (",levelNames1[1],")*(",age2,") ) + ((",levelNames1[2],")*(",age2,")^2/2) + ((",levelNames1[3],")*(",age2,")^3/3) ) - ( ((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[3],")*(",age1,")^3/3)  + ( (",levelNames1[1],")*(",age1,") ) + ((",levelNames1[2],")*(",age1,")^2/2) + ((",levelNames1[3],")*(",age1,")^3/3) )) - (( ((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2)   + ((",rowNames[3],")*(",age2,")^3/3)   ) - ( ((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[3],")*(",age1,")^3/3)    )) ") ) ,parameterNames = rowNames)

        }else if(modelType() == "Cubic"){

          res <- deltaMethod(fit(), c( paste0(" (( ((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2)  + ((",rowNames[3],")*(",age2,")^3/3) + ((",rowNames[4],")*(",age2,")^4/4)   + ( (",levelNames1[1],")*(",age2,") ) + ((",levelNames1[2],")*(",age2,")^2/2) + ((",levelNames1[3],")*(",age2,")^3/3) + ((",levelNames1[4],")*(",age2,")^4/4) ) - ( ((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[3],")*(",age1,")^3/3)  + ((",rowNames[4],")*(",age1,")^4/4)  + ( (",levelNames1[1],")*(",age1,") ) + ((",levelNames1[2],")*(",age1,")^2/2) + ((",levelNames1[3],")*(",age1,")^3/3) + ((",levelNames1[4],")*(",age1,")^4/4) )) - (( ((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2)   + ((",rowNames[3],")*(",age2,")^3/3)  + ((",rowNames[4],")*(",age2,")^4/4)  ) - ( ((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[3],")*(",age1,")^3/3)  + ((",rowNames[4],")*(",age1,")^4/4)    )) ") ) ,parameterNames = rowNames)

        }else if(modelType() == "Quartic"){

          res <- deltaMethod(fit(), c( paste0(" (( ((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2)  + ((",rowNames[3],")*(",age2,")^3/3) + ((",rowNames[4],")*(",age2,")^4/4) + ((",rowNames[5],")*(",age2,")^5/5)   + ( (",levelNames1[1],")*(",age2,") ) + ((",levelNames1[2],")*(",age2,")^2/2) + ((",levelNames1[3],")*(",age2,")^3/3) + ((",levelNames1[4],")*(",age2,")^4/4)  + ((",levelNames1[5],")*(",age2,")^5/5) ) - ( ((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[3],")*(",age1,")^3/3)  + ((",rowNames[4],")*(",age1,")^4/4) + ((",rowNames[5],")*(",age1,")^5/5)  + ( (",levelNames1[1],")*(",age1,") ) + ((",levelNames1[2],")*(",age1,")^2/2) + ((",levelNames1[3],")*(",age1,")^3/3) + ((",levelNames1[4],")*(",age1,")^4/4) + ((",levelNames1[5],")*(",age1,")^5/5) )) -  (( ((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2)   + ((",rowNames[3],")*(",age2,")^3/3)  + ((",rowNames[4],")*(",age2,")^4/4) + ((",rowNames[5],")*(",age2,")^5/5)   ) - ( ((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[3],")*(",age1,")^3/3)  + ((",rowNames[4],")*(",age1,")^4/4)  + ((",rowNames[5],")*(",age1,")^5/5)    )) ") ) ,parameterNames = rowNames)

        }
        }
        dif <- paste0( abs(round(res$Estimate, 2)), " 95% CI: (", abs(round(res$`2.5 %`,2)), " - ", abs(round(res$`97.5 %`,2)), ")")
        statement <- paste0("The difference between the two factor levels (for the age ranges ", input$AUCages[1], " - ", input$AUCages[2] ,") is ", dif ,".")

        return(statement)
        }else if(input$varType == "cont"){
          levelNames <- paste0(input$condition) %>%
            str_remove_all("I|\\(|\\^|\\)|\\:")

          coef <- summary(fit())$coefficients

          ageOrig <- modelDataEdit() %>%
            pull(age_original)
          ageOrig <- ageOrig[!is.na(ageOrig)]
          age1 <- input$AUCages[1] - mean(ageOrig)
          age2 <- input$AUCages[2] - mean(ageOrig)

          rowNames <- rownames(coef) %>%
            str_remove_all("I|\\(|\\^|\\)|\\:")

          levelNames1 <- rowNames[str_detect(rowNames, paste0(levelNames, collapse = "|"))]

          if(modelType() == "Linear"){
            res <- deltaMethod(fit(), c( paste0(" (( ((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2)   + ( (",levelNames1[1],")*(",age2,") ) + ((",levelNames1[2],")*(",age2,")^2/2) ) - ( ((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2)   + ( (",levelNames1[1],")*(",age1,") ) + ((",levelNames1[2],")*(",age1,")^2/2) ))  - ( ( ((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2)   - ( (",levelNames1[1],")*(",age2,") ) - ((",levelNames1[2],")*(",age2,")^2/2) ) - ( ((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2)   - ( (",levelNames1[1],")*(",age1,") ) - ((",levelNames1[2],")*(",age1,")^2/2) ) ) ") ) ,parameterNames = rowNames)
          }else if(modelType() == "Quadratic"){
            res <- deltaMethod(fit(), c( paste0(" (( ((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2)  + ((",rowNames[3],")*(",age2,")^3/3)   + ( (",levelNames1[1],")*(",age2,") ) + ((",levelNames1[2],")*(",age2,")^2/2) + ((",levelNames1[3],")*(",age2,")^3/3) ) - ( ((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[3],")*(",age1,")^3/3)  + ( (",levelNames1[1],")*(",age1,") ) + ((",levelNames1[2],")*(",age1,")^2/2) + ((",levelNames1[3],")*(",age1,")^3/3) )) -  (( ((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2)  + ((",rowNames[3],")*(",age2,")^3/3)   - ( (",levelNames1[1],")*(",age2,") ) - ((",levelNames1[2],")*(",age2,")^2/2) - ((",levelNames1[3],")*(",age2,")^3/3) ) - ( ((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[3],")*(",age1,")^3/3)  - ( (",levelNames1[1],")*(",age1,") ) - ((",levelNames1[2],")*(",age1,")^2/2) - ((",levelNames1[3],")*(",age1,")^3/3) )) ") ) ,parameterNames = rowNames)

          }else if(modelType() == "Cubic"){
            res <- deltaMethod(fit(), c( paste0(" (( ((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2)  + ((",rowNames[3],")*(",age2,")^3/3) + ((",rowNames[4],")*(",age2,")^4/4)   + ( (",levelNames1[1],")*(",age2,") ) + ((",levelNames1[2],")*(",age2,")^2/2) + ((",levelNames1[3],")*(",age2,")^3/3) + ((",levelNames1[4],")*(",age2,")^4/4) ) - ( ((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[3],")*(",age1,")^3/3)  + ((",rowNames[4],")*(",age1,")^4/4)  + ( (",levelNames1[1],")*(",age1,") ) + ((",levelNames1[2],")*(",age1,")^2/2) + ((",levelNames1[3],")*(",age1,")^3/3) + ((",levelNames1[4],")*(",age1,")^4/4) )) - (( ((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2)  + ((",rowNames[3],")*(",age2,")^3/3) + ((",rowNames[4],")*(",age2,")^4/4) - ( (",levelNames1[1],")*(",age2,") ) - ((",levelNames1[2],")*(",age2,")^2/2) - ((",levelNames1[3],")*(",age2,")^3/3) - ((",levelNames1[4],")*(",age2,")^4/4) ) - ( ((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[3],")*(",age1,")^3/3)  + ((",rowNames[4],")*(",age1,")^4/4)  - ( (",levelNames1[1],")*(",age1,") ) - ((",levelNames1[2],")*(",age1,")^2/2) - ((",levelNames1[3],")*(",age1,")^3/3) - ((",levelNames1[4],")*(",age1,")^4/4) )) ") ) ,parameterNames = rowNames)

          }else if(modelType() == "Quartic"){

            res <- deltaMethod(fit(), c( paste0(" (( ((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2)  + ((",rowNames[3],")*(",age2,")^3/3) + ((",rowNames[4],")*(",age2,")^4/4) + ((",rowNames[5],")*(",age2,")^5/5)   + ( (",levelNames1[1],")*(",age2,") ) + ((",levelNames1[2],")*(",age2,")^2/2) + ((",levelNames1[3],")*(",age2,")^3/3) + ((",levelNames1[4],")*(",age2,")^4/4)  + ((",levelNames1[5],")*(",age2,")^5/5) ) - ( ((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[3],")*(",age1,")^3/3)  + ((",rowNames[4],")*(",age1,")^4/4) + ((",rowNames[5],")*(",age1,")^5/5)  + ( (",levelNames1[1],")*(",age1,") ) + ((",levelNames1[2],")*(",age1,")^2/2) + ((",levelNames1[3],")*(",age1,")^3/3) + ((",levelNames1[4],")*(",age1,")^4/4) + ((",levelNames1[5],")*(",age1,")^5/5) )) - (( ((",age2,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age2,")^2/2)  + ((",rowNames[3],")*(",age2,")^3/3) + ((",rowNames[4],")*(",age2,")^4/4) + ((",rowNames[5],")*(",age2,")^5/5)   - ( (",levelNames1[1],")*(",age2,") ) - ((",levelNames1[2],")*(",age2,")^2/2) - ((",levelNames1[3],")*(",age2,")^3/3) - ((",levelNames1[4],")*(",age2,")^4/4)  - ((",levelNames1[5],")*(",age2,")^5/5) ) - ( ((",age1,")*(",rowNames[1],")) + ((",rowNames[2],")*(",age1,")^2/2) + ((",rowNames[3],")*(",age1,")^3/3)  + ((",rowNames[4],")*(",age1,")^4/4) + ((",rowNames[5],")*(",age1,")^5/5)  -( (",levelNames1[1],")*(",age1,") ) - ((",levelNames1[2],")*(",age1,")^2/2) - ((",levelNames1[3],")*(",age1,")^3/3) - ((",levelNames1[4],")*(",age1,")^4/4) - ((",levelNames1[5],")*(",age1,")^5/5) )) ") ) ,parameterNames = rowNames)

          }

          dif <- paste0( abs(round(res$Estimate, 2)), " 95% CI: (", abs(round(res$`2.5 %`,2)), " - ", abs(round(res$`97.5 %`,2)), ")")
          statement <- paste0("The difference between the +1 SD and -1 SD (for the age ranges ", input$AUCages[1], " - ", input$AUCages[2] ,") is ", dif ,".")
          return(statement)
        }else{
          return(paste0(NA))
        }

      })

      output$AUCdifText <- renderText({
        if(input$varType == "cat" & length(input$levelsAUC == 2) | input$varType == "cont"){
        difference()
        }else{
        " "
        }
      })

      #################################################################################
      # ----- DOWNLOADING RESULTS TAB -------
      ###############################################################
      # Add UI to download results
      output$buttonHere <- renderUI({
        req(plot())
        tagList(
          downloadButton(ns("downloadReport"), "Download report")
        )
      })

      output$downloadReport <- downloadHandler(
        filename = function(){
          paste0("Interaction_Variable_", Sys.Date(), ".pdf")
        },
        content = function(file) {
          # Copy the report file to a temporary directory before processing it, in
          # case we don't have write permissions to the current working dir (which
          # can happen when deployed).
          tempReport <- file.path("www/interactionVar.Rmd")
          file.copy("interactionVar.Rmd", tempReport, overwrite = TRUE)



          # -------Set up parameters to pass to Rmd document--------
          # pass condition selection to an object for report?
          condition <- reactive({ input$condition })
          # pass vartype to an object for report?
          vartype <- reactive({ input$varType })

          if( length(input$ageInputScore) == 0 & length(input$AUCages) == 0 ){
            params <- list(
              cond = condition(),
              condtype = vartype(),
              condPlot = plot(),
              condModelForm = modelform(),
              condFixed = modelStatsFixed(),
              interpretation = interpretation(),
              condRandom = modelStatsRandom(),
              modelDataEdit = modelDataEdit(),
              plotScore = NA,
              tableScore = NA,
              difTab = NA,
              AUCplot = NA,
              AUCtable = NA,
              difference = NA,
              traj = traj(),
              modelType = modelType()
            )
          }else if( length(input$ageInputScore) == 0 & length(input$AUCages) > 0 ){
            params <- list(
              cond = condition(),
              condtype = vartype(),
              condPlot = plot(),
              condModelForm = modelform(),
              condFixed = modelStatsFixed(),
              interpretation = interpretation(),
              condRandom = modelStatsRandom(),
              modelDataEdit = modelDataEdit(),
              plotScore = NA,
              tableScore = NA,
              difTab = NA,
              AUCplot = plotAUC(),
              AUCtable = tableAUC(),
              difference = difference(),
              traj = traj(),
              modelType = modelType()
            )
          }else if( length(input$ageInputScore) > 0 & length(input$AUCages) == 0 ){
            params <- list(
              cond = condition(),
              condtype = vartype(),
              condPlot = plot(),
              condModelForm = modelform(),
              condFixed = modelStatsFixed(),
              interpretation = interpretation(),
              condRandom = modelStatsRandom(),
              modelDataEdit = modelDataEdit(),
              plotScore = plotScoreAll(),
              tableScore = tableScoreAll(),
              difTab = difTab(),
              AUCplot = NA,
              AUCtable = NA,
              difference = difference(),
              traj = traj(),
              modelType = modelType()
            )
          }else{
            params <- list(
              cond = condition(),
              condtype = vartype(),
              condPlot = plot(),
              condModelForm = modelform(),
              condFixed = modelStatsFixed(),
              interpretation = interpretation(),
              condRandom = modelStatsRandom(),
              modelDataEdit = modelDataEdit(),
              plotScore = plotScoreAll(),
              tableScore = tableScoreAll(),
              difTab = difTab(),
              AUCplot = plotAUC(),
              AUCtable = tableAUC(),
              difference = difference(),
              traj = traj(),
              modelType = modelType()
            )
          }

          # Knit the document, passing in the `params` list, and eval it in a
          # child of the global environment (this isolates the code in the document
          # from the code in this app).
          rmarkdown::render(tempReport, output_file = file,
                            params = params,
                            envir = new.env(parent = globalenv())
          )
        }
)

      ###
      return(
        list(
          condType = reactive({ input$varType }),
          cond = reactive({ input$condition }),
          condPlot = reactive({ output$modelCondPlot  }),
          condModelForm = reactive({ output$form }),
          condFixed = reactive({ output$modelStatsFixed }),
          condRandom = reactive({ output$modelStatsRandom }),
          modelDataEdit = reactive({ modelDataEdit })
        )
      )

    }
  )
}

